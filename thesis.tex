\documentclass[a4paper,fontsize=12pt]{scrartcl}
\usepackage{reg2021}
\usepackage{quiver}
\usepackage{bbold}

% Gotta find a better solution to be able to show all of the diagrams properly
\addtolength{\oddsidemargin}{-.875in}
\addtolength{\evensidemargin}{-.875in}
\addtolength{\textwidth}{1.75in}

\addtolength{\topmargin}{-.875in}
\addtolength{\textheight}{1.75in}

\begin{document}
\noindent\textbf{Author}\hfill\textbf{Year} \linebreak
\vspace*{-.1cm} Matteo Durante\hfill 2022 \\

\noindent
\rule{\linewidth}{1pt}
\begin{center}
\Large
    \textbf{Localizations of Models of Dependent Type Theory} \\
\end{center}
\rule{\linewidth}{1pt}
\\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\La}{\Lambda}
\newcommand{\pa}{c}
\newcommand{\ob}{\operatorname{Ob}}
\newcommand{\mor}{\operatorname{Mor}}
\newcommand{\sto}{\twoheadrightarrow}

\newcommand{\plim}{\varprojlim}
\newcommand{\sst}{\subseteq}
\newcommand{\eq}{\operatorname{eq}}

\newcommand{\f}{\varphi}

\newcommand{\sing}{\operatorname{Sing}}

\newcommand{\ihom}{\underline{\Hom}}

\section{This is [not] an outline}

We can also rewrite the paper by Kapulkin about LCCC arising from TT using the
language of localizations of quasi-categories. There they develop the relevant
theory showing that under some conditions the frame associated to a fibration
category is locally cartesian closed, but using Cisinski's results we can prove
the same theorem directly using a more mainstream theory.

What should be included in such an overview?

1- Cisinski's theory of localizations (of fibration $\infty$-categories)

2- an introduction to contextual categories: where do they come from? Why are
they useful? Check out Voevodsky's papers about C-systems

We explain what dependent type theory is (Martin-Lof's notes from 1984) and why
it's an interesting foundation of mathematics. We mention Homotopy Type Theory
as an effort to provide homotopical foundations which better model how we think
about identities, which explains why intensional identity types are more
interesting to us than extensional ones.

We move on to defining contextual categories (1211.2851, 1406.7413, 1507.02648)
and what
the Pi, Sigma and Id structures are (1406.7413, 1211.2851 Appendix B). To
understand what the link between such structures and syntactically presented
type theories we refer to 1507.02648, Sec.\ 1.1, while the statement of the
conjectured correspondence is in 1304.0680, Sec.\ 2.1.

Where does the link between dependent type theories and $\infty$-categories come
from? We see that $\infty$-categories intuitively model the behavior of type
theories and their type constructions, especially when considering Homotopy Type
Theory, however this relation is known only
partially (references in the intro of 1507.02648). The idea is that the type
theory we are interested in should be the internal language of some class of
$\infty$-categories and a precise statement would require us to provide
homotopical functors in both directions which induce an equivalence on the
associated $\infty$-categories. The idea is to construct the
functor from contextual categories as a localization functor, that is we need to
provide a homotopical structure on contextual categories, as they do in
1507.02648 (there should be an older reference) which then provides an
associated $\infty$-category. This is the object of the Initiality Conjecture,
stated in 1610.00037, in the hope that such a correspondence will extend to
Homotopy Type Theory and some notion of Elementary Higher Toposes, perhaps the
one specified in 1805.03805. At the moment we know that HoTT can be interpreted
in Higher Toposes with some structure. Current progress: 1709.09519, an upcoming
paper by Nguyen-Uemura (HoTTest talk).

Our aim is to show that when taking contextual categories with the structure we
specified earlier we obtain a locally cartesian closed $\infty$-category. To do
so we provide a fibrational structure on contextual categories (1304.0680,
1507.02648), which as we anticipate will imply that their simplicial
localizations are finitely complete. We also prove that the hypothesis of
\cite[Thm.\ 7.6.16]{Cis19} are satisfied, informing that this will be sufficient
to prove Kapulkin's main result from 1507.02648.

We then develop the theory of localizations of $\infty$-categories by Cisinski
and specifically develop the results concerning $\infty$-categories with
fibrations and weak equivalences. Localizations of such $\infty$-categories are
finitely complete. The objective is to show \cite[Thm.\ 7.6.16]{Cis19}. How in
depth should we go?

Why all of this is interesting: we are proving Kapulkin's result internalizing
all of the discussion within the language of $\infty$-category theory and
relying only on its simplicial model.

\section{Contextual categories}

There are many models of dependent type theory from category theory in
the literature, like \emph{category with attributes}, \emph{categories with
families} and \emph{comprehension categories}, which are
fairly similar among them, as shown by the adjunctions between their categories.
Here we shall work with \emph{contextual
category}, which were first explored by Cartmell and Streicher in
\wfd{(INSERT REFS)} and later by Voevodsky, under the name $C$\emph{-systems},
in \wfd{(MORE REFS)}. Lumsdaine in his phd thesis claims that contextual
categories are the right framework PROP 1.2.5.

\begin{defn}
  A \emph{contextual category} $\cC$ is a category with the following data:
  \begin{enumerate}
    \item a small category, which we also call $\cC$, with a grading on objects
      $\Ob\cC=\coprod_{n\in\bbN}\Ob_n\cC$;
    \item an object $*\in\Ob_0\cC$;
    \item for each $n\in\bbN$, a map
      $ft_n\colon\Ob_{n+1}\cC\rightarrow\Ob_n\cC$, often simply denoted $ft$;
    \item for each $n\in\bbN$ and $X\in\Ob_{n+1}\cC$, a map $p_X\colon
      X\rightarrow ftX$;
    \item for each $n\in\bbN$, $X\in\Ob_{n+1}\cC$ and $f\colon Y\rightarrow
      ftX$, an object $f^*X$ and a map $q(f,X)\colon f^*X\rightarrow X$;
  \end{enumerate}
  such that:
  \begin{enumerate}
    \item $*$ is the unique element of $\Ob_0\cC$;
    \item $*$ is terminal;
    \item for each $n$, $X\in\Ob_{n+1}\cC$ and $f\colon Y\rightarrow ftX$, we
      have $ft f^*X=Y$ and the square
      \[\begin{tikzcd}
        {f^*X} & X \\
        Y & ftX
        \arrow["f"', from=2-1, to=2-2]
        \arrow["{p_X}", from=1-2, to=2-2]
        \arrow["{q(f,X)}", from=1-1, to=1-2]
        \arrow["{p_{f^*X}}"', from=1-1, to=2-1]
      \end{tikzcd}\]
      is a pullback;
    \item for each $n\in\bbN$, $X\in\Ob_{n+1}\cC$ and pair of maps $f\colon
      Y\rightarrow ft X$, $g\colon Z\rightarrow Y$, we have $(fg)^*X=g^*f^*X$,
      $1^*_{ftX}X=X$, $q(fg,X)=q(f,X)\cdot q(g,f^*X)$ and $q(1_{ftX},X)=1_X$.
  \end{enumerate}
\end{defn}

\begin{rmk}
  The last condition in the definition means that our choice of pullbacks is
  functorial, which allows us to see contextual categories as a strict model of
  dependent type theory, not requiring keeping track of coherency maps.
  Other models, like comprehension categories, do not
  have such requirements, which makes them more general but also
  interpretation harder, unless they are first strictified, that is replaced by
  an equivalent strict model of the same kind, like split comprehension
  categories \wfd{(HOW DO YOU STRICTIFY THEM?)}. Famously, we also have
  homotopical models of dependent type
  theories, like tribes and fibration categories \wfd{(REFERENCE)}, whose
  internal languages are precisely dependent type theories with intensional
  $\Id$-types and $\Sigma$-types.
\end{rmk}

A motivating example for contextual categories is the \emph{syntactic category
of a dependent type theory}, which constructs from a dependent type theory $T$ a
contextual category $Syn(T)$ explicitly modeling it as we will show.

\begin{construction}
  REF 1211

  Given a dependent type theory $T$ with the structural rules specified in REFS,
  its syntactic category $Syn(T)$ has:
  \begin{enumerate}
    \item $\Ob_nSyn(T)$ given by contexts $[x_1:A_1,\ldots,x_n:A_n]$ of length
      $n$, modulo definitional equality and renaming of free variables;
    \item maps are \emph{context morphisms}, or \emph{substitutions}, modulo
      definitional equalities and renaming of free variables. This means that a
      map
      \[f\colon[x_1:A_1,\ldots,x_n:A_n]\rightarrow[y_1:B_1,\ldots,y_m:B_m(y_1,\ldots,y_{m-1})]\]
      is an equivalence class of sequences of terms $f_1,\ldots,f_m$ such that
      \begin{align*}
        x_1:A_1,\ldots,x_n:A_n &\vdash f_1:B_1, \\
        \vdots & \\
        x_1:A_1,\ldots,x_n:A_n &\vdash f_m:B_m(f_1,\ldots,f_{m-1}), \\
      \end{align*}
      are all derivable judgements and two such sequences $f,g$ are equivalent
      if we have
      \[x_1:A_1,\ldots,x_n:A_n\vdash f_i\equiv g_i\:B_i(f_1,\ldots,f_{i-1})\]
      for every $i$, where $\equiv$ represents judgemental equality; we shall
      henceforth write $[f_i]$ for such sequences of terms up to equivalence
      specifying maps between contexts;
    \item composition is given by substitution, that is given
      $[f]\colon\Gamma\rightarrow\Delta$, $[g]\colon\Delta\rightarrow\Theta$ we
      have a map $[g]\colon\Gamma\rightarrow\Theta$ induced by the same sequence
      of terms;
    \item the identity $\Gamma\rightarrow\Gamma$ is given by the variables of
      $\Gamma$, considered as
      terms, that is we take the sequence $[x_i]$ given by
      \begin{align*}
        x_1:A_1,\ldots,x_n:A_n &\vdash x_1:A_1, \\
        \vdots & \\
        x_1:A_1,\ldots,x_n:A_n &\vdash x_n:A_n(x_1,\ldots,x_{n-1});
      \end{align*}
    \item the terminal object is the empty context $[]$;
    \item
      $ft([x_1:A_1,\ldots,x_{n+1}:A_{n+1}])=[x_1:A_1,\ldots,x_n:A_n]$;
    \item for $\Gamma=[x_1:A_1,\ldots,x_n:A_{n+1}]$,
      $p_{\Gamma}\colon\Gamma\rightarrow ft\Gamma$ is the \emph{dependent
      projection context morphism} $[x_1,\ldots,x_n]$, defined by
      \begin{align*}
        x_1:A_1,\ldots,x_{n+1}:A_{n+1} &\vdash x_1:A_1, \\
        \vdots & \\
        x_1:A_1,\ldots,x_{n+1}:A_{n+1} &\vdash x_n:A_n(x_1,\ldots,x_n)
      \end{align*}
      and thereby simply forgetting the last variable of $\Gamma$;
    \item given contexts
      \begin{align*}
        \Gamma &=[x_1:A_1,\ldots,x_{n+1}:A_{n+1}(x_1,\ldots,x_n)], \\
        \Delta &=[y_1:B_1,\ldots,y_m:B_m(y_1,\ldots,y_{m-1})]
      \end{align*}
      and a map $f=[f_i(y)]\colon\Delta\rightarrow ft\Gamma$ (where $y$ is a
      vector of variables of length $m$), the pullback $f^*\Gamma$ is the
      context
      \[[y_1:B_1,\ldots,y_m:B_m(y_1,\ldots,y_{m-1}),y_{m+1}:A_{n+1}(f_1(y),\ldots,f_n(y))]\]
      for some new variable $y_{m+1}$, while $q(\Gamma,f)\colon
      f^*\Gamma\rightarrow\Gamma'$ is specified by $[f_1,\ldots,f_n,y_{m+1}]$.
  \end{enumerate}
\end{construction}

\begin{rmk}
  Given a dependent type theory $T$, the terms $t:A$ of a type over a context
  $\Gamma$ can be recovered (up to definitional equality) from the syntactic
  category $Syn(T)$ by looking at sections of the basic dependent projection
  $p_{[\Gamma,x:A]}\colon[\Gamma,x:A]\rightarrow[\Gamma]$, which indeed act as
  identities over $\Gamma$ and furthermore specify a term $\Gamma\vdash t:A$.
  Given the importance of such maps, we shall often simply write ``sections'' to
  refer to sections of basic dependent projections, without specifying which ones
  unless it creates ambiguity.

  The above construction also tells us how to think about the other elements in
  the definition of contextual categories: basic dependent
  projections $p_B\colon\Gamma.A.B\rightarrow\Gamma.A$ represent dependent
  types $B(x)$ over $x:A$ in the context $\Gamma$ and pulling back along
  a dependent projection corresponds to substituting variables, while a choice of
  a term corresponds to a choice of a section of a basic dependent projection
  and so on for the other objects in the definition.
\end{rmk}

\begin{rmk}
  We shall also make use of some conventions inspired by this construction.
  Namely, given a contextual category $\cC$ and an object $\Gamma\in\Ob_n\cC$,
  we shall
  write $(\Gamma,A_1,\ldots,A_k)$, $\Gamma.A_1.\ldots.A_k$ and $\Gamma.\Delta$
  interchangeably
  for an object $X$ in $\Ob_{n+k}\cC$ with $ft^kX=\Gamma$ and call it a
  \emph{context extension of $\Gamma$ of length $k$}. We shall
  also write $p_{(A_1,\ldots,A_k)}$, $p_{A_1.\ldots.A_k}$ and $p_\Delta$ for the
  composition of the basic dependent projections
  $p_{\Gamma.A_1.\ldots.A_i}$, with $i$
  ranging from $1$ to $k$, and the resulting map will be called a
  \emph{dependent projection}. In the case where $k=1$, $p_{A_1}$ corresponds to
  a basic dependent projection and the context extension of $\Gamma$ will be
  \emph{simple}, while if $k=0$ we have $p=\Id_{\Gamma}$ and then the context
  extension will be \emph{trivial}. Greek letters shall be
  used to indicate context extensions of arbitrary length, while Latin ones will
  be reserved to simple extensions.

  Continuing, given a dependent projection $p_{A_1.\ldots.A_k}=p_\Theta$ as
  above and a context morphism $f\colon\Delta\rightarrow\Gamma$, we define
  inductively $\Delta.f^*A_1.\ldots.f^*A_k=\Delta.f^*\Theta$ and
  $q(f,A_1.\ldots.A_k)=q(f,\Theta)$ by looking at the pasting of pullback
  squares
  \[\begin{tikzcd}
    {\Delta.f^*A_1.\ldots.f^*A_k} & {\Delta.f^*A_1.\ldots.f^*A_{k-1}} & \cdots & {\Delta.f^*A_1} & \Delta \\
    {\Gamma.A_1.\ldots.A_k} & {\Gamma.A_1.\ldots.A_{k-1}} & \cdots & {\Gamma.A_1} & \Gamma
    \arrow["f", from=1-5, to=2-5]
    \arrow["{p_{A_1}}", from=2-4, to=2-5]
    \arrow["{p_{f^*A_1}}"', from=1-4, to=1-5]
    \arrow["{q(f,A_1)}"', from=1-4, to=2-4]
    \arrow[from=2-3, to=2-4]
    \arrow[from=1-3, to=1-4]
    \arrow[from=1-2, to=1-3]
    \arrow[from=2-2, to=2-3]
    \arrow["{q(f,A_1.\ldots.A_{k-1})}", from=1-2, to=2-2]
    \arrow["{q(f,A_1.\ldots.A_k)}"', from=1-1, to=2-1]
    \arrow["{p_{f^*A_k}}"', from=1-1, to=1-2]
    \arrow["{p_{A_k}}", from=2-1, to=2-2]
    \arrow["{p_{f^*A_1.\ldots.f^*A_k}}", curve={height=-24pt}, from=1-1, to=1-5]
    \arrow["{p_{A_1.\ldots.A_k}}"', curve={height=24pt}, from=2-1, to=2-5]
  \end{tikzcd},\]
  where
  $q(f,A_1.\ldots.A_k)=q(q(f,A_1),A_2.\ldots.A_k)=q(q(f,A_1.\ldots.A_{k-1}),A_k)$.
  As usual, if $k=0$ we have $q(f,\Theta)=f$, $f^*(\Gamma.\Theta)=\Gamma$, while
  for $k=1$ we have $q(f,A_1)=q(f,\Gamma.A_1)$, $\Delta.f^*A_1=f^*(\Gamma.A_1)$.

  Finally, given a section $a\colon\Gamma\rightarrow\Gamma.A$ and a context
  morphism $f\colon\Delta\rightarrow\Gamma$, we also want to specify $f^*a$,
  that is the term of $A$ which we get by switching context. This is given by
  the map $(1_{\Delta},a\cdot f)$ specified by the pullback square
  \[\begin{tikzcd}
    \Delta \\
    & {\Delta.f^*A} & {\Gamma.A} \\
    & \Delta & \Gamma
    \arrow["f"', from=3-2, to=3-3]
    \arrow["{p_{f^*A}}", from=2-2, to=3-2]
    \arrow["{p_A}", from=2-3, to=3-3]
    \arrow["{q(f,A)}"', from=2-2, to=2-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["{a\cdot f}", curve={height=-12pt}, from=1-1, to=2-3]
    \arrow["{(1_\Delta,a\cdot f)}"{description}, dotted, from=1-1, to=2-2]
  \end{tikzcd},\]
  and, as shown by the commutative diagram
  \[\begin{tikzcd}
    \Delta & \Gamma \\
    {\Delta.f^*A} & {\Gamma.A} \\
    \Delta & \Gamma
    \arrow["f"', from=3-1, to=3-2]
    \arrow["{p_{f^*A}}", from=2-1, to=3-1]
    \arrow["{p_A}"', from=2-2, to=3-2]
    \arrow["{q(f,A)}"', from=2-1, to=2-2]
    \arrow["a"', from=1-2, to=2-2]
    \arrow["{f^*a}", from=1-1, to=2-1]
    \arrow["f", from=1-1, to=1-2]
    \arrow[curve={height=-24pt}, Rightarrow, no head, from=1-2, to=3-2]
    \arrow[curve={height=24pt}, Rightarrow, no head, from=1-1, to=3-1]
  \end{tikzcd},\]
  it corresponds to the pullback of $a$ along $q(f,A)$. By the techniques we
  provided earlier, we extend this construction to contexts of arbitrary length.
\end{rmk}

\begin{defn}
  A \emph{contextual functor} between contextual categories
  $F\colon\cC\rightarrow\cD$ is a functor on the underlying categories which
  preserves the grading, basic dependent projections and such that
  $q(Ff,FX)=F(q(f,X))$.
\end{defn}

\begin{rmk}
  Our definition allows us to see contextual categories as models for an
  essentially algebraic theory with sorts indexed by $\bbN+\bbN\times\bbN$. In
  that context, we get a notion of morphisms between models of this theory,
  which coincides with the one we have just provided. The category of models for
  this theory will be the category of contextual categories, denoted by $Cxl$,
  which will be complete and cocomplete as the category of models of an
  essentially algebraic theory REFS.
\end{rmk}

A problem of providing a model of dependent type theory is exhibiting the
basic structural rules, namely context substitution, variable binding,
variable substitution and so on for us. The defining properties of contextual
categories are meant to model them and therefore 
take care of all of that for us, meaning that as long
as we can show that something models a contextual category we automatically get
an interpretation of dependent type theory, thereby eliminating a lot of
bureaucracy. For this to be true, however, we need the following statement,
which we shall assume because the results we need rely on it.

\begin{conj}[Initiality]
  Given a dependent type theory $T$, its syntactic category $Syn(T)$ is initial
  in the category of contextual categories with the appropriate structure.
\end{conj}

Here by ``appropriate structure'' we mean extra structures meant to model the
logical rules of the type theory, like $\Sigma$-types, $\Pi$-types and
$\Id$-types. Indeed, the definition of contextual category as we said deals with
the structural rules, but nothing more.
Similar results have been proven for some simple dependent type theories in
STREICHER91 and HOFMANN95, however we still do not have a general statement.
Such a statement would first require a general notion of dependent type
theory, which has been worked on in 1904.04097, 2009.05539, 2205.00798, and
there is an ongoing effort to provide a formalization and a flexible proof of
some variants of the conjecture via proof assistants \wfd{(HOTTEST TALK
SLIDES)}.

If we could do that, then for any contextual category $\cC$ we would have a
contextual functor $Syn(T)\rightarrow\cC$ explaining how to interpret $T$ in
$\cC$. This is essentually an algorithmic problem: it reduces to explaining
inductively to a computer how to construct the aforementioned functor.

We now define the extra structures on contextual categories we mentioned
earlier. Our definitions shall be taken from 1211, 1808.

\begin{defn}
  A \emph{$\Sigma$-type structure} on a contextual category $\cC$ consists of:
  \begin{enumerate}
    \item for each $(\Gamma,A,B)\in\Ob_{n+2}\cC$, an object
      $(\Gamma,\Sigma(A,B))\in\Ob_{n+1}\cC$;
    \item for each $(\Gamma,A,B)\in\Ob_{n+2}\cC$, a morphism $pair_{A,B}\colon
      (\Gamma,A,B)\rightarrow(\Gamma,\Sigma(A,B))$ over $\Gamma$;
    \item for each $(\Gamma,A,B),(\Gamma,\Sigma(A,B),C)\in\Ob_{n+2}\cC$, and
      $d\colon(\Gamma,A,B)\rightarrow(\Gamma,\Sigma(A,B),C)$ with $p_C\cdot
      d=pair_{A,B}$, a section
      $split_d\colon(\Gamma,\Sigma(A,B))\rightarrow(\Gamma,\Sigma(A,B),C)$ such
      that $split_d\cdot pair_{A,B}=d$;
    \item where all of the above is compatible with context substitution, that
      is given a map $f\colon\Delta\rightarrow\Gamma$ we have
      \begin{align*}
        f^*(\Gamma,\Sigma(A,B)) &=(\Delta,\Sigma(f^*A,f^*B)), \\
        f^*pair_{A,B} &=pair_{f^*A,f^*B}, \\
        f^*split_d &=split_{f^*d}.
      \end{align*}
  \end{enumerate}
\end{defn}

\begin{defn}
  A \emph{$\Id$-type structure} on a contextual category $\cC$ consists of:
  \wfd{COMPLETE}
\end{defn}

\begin{defn}
  A \emph{$\Pi$-type structure} on a contextual category $\cC$ consists of:
  \begin{enumerate}
    \item for each $(\Gamma,A,B)\in\Ob_{n+2}\cC$, an object
      $(\Gamma,\Pi(A,B))\in\Ob_{n+1}\cC$;
    \item for each $(\Gamma,A,B)\in\Ob_{n+2}\cC$, a map
      $\app_{A,B}\colon(\Gamma,\Pi(A,B),p^*_{\Pi(A,B)}A)\rightarrow(\Gamma,A,B)$
      over $\Gamma$, that is such that $p_B\cdot app_{A,B}=q(\Pi(A,B),A)$;
    \item for each $(\Gamma,A,B)\in\Ob_{n+2}\cC$ and section
      $b\colon(\Gamma,A)\rightarrow(\Gamma,A,B)$, a section
      $\lambda_{A,B}(b)\colon\Gamma\rightarrow(\Gamma,\Pi(A,B))$;
    \item such that for any sections
      $k\colon\Gamma\rightarrow(\Gamma,\Pi(A,B))$, $a\colon\Gamma\rightarrow A$
      the map $\app_{A,B}(k,a)$ defined as the composition of $\app_{A,B}$ with
      $(k,a)$ specified by the factorization through the pullback
      \[\begin{tikzcd}
        \Gamma \\
        & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.A} \\
        & {\Gamma.\Pi(A,B)} & \Gamma
        \arrow["{p_{\Pi(A,B)}}"', from=3-2, to=3-3]
        \arrow["{p_A}", from=2-3, to=3-3]
        \arrow["{q(p_{\Pi(A,B)},A)}"', from=2-2, to=2-3]
        \arrow["{p_{p^*_{\Pi(A,B)}A}}", from=2-2, to=3-2]
        \arrow["a", curve={height=-12pt}, from=1-1, to=2-3]
        \arrow["k"', curve={height=12pt}, from=1-1, to=3-2]
        \arrow["{(k,a)}"{description}, dotted, from=1-1, to=2-2]
      \end{tikzcd},\]
      we have $p_B\cdot\app_{A,B}(k,a)=a$;
    \item such that for any $(\Gamma,A,B)$, $a\colon\Gamma\rightarrow(\Gamma,A)$
      and $b\colon(\Gamma,A)\rightarrow(\Gamma,A,B)$ we have
      \[\app(\lambda_{A,B}(b),a)=b\cdot a;\]
    \item all of the above is compatible with context substitution, that is for
      any $f\colon\Delta\rightarrow\Gamma$ we have
      \begin{align*}
        f^*(\Gamma,\Pi(A,B)) &=(\Delta,\Pi(f^*A,f^*B)), \\
        f^*\lambda_{A,B}(b) &=\lambda_{f^*A,f^*B}(f^*b), \\
        f^*(\app_{A,B}(k,a)) &=\app_{f^*A,f^*B}(f^*k,f^*a).
      \end{align*}
  \end{enumerate}

  We shall say that the the $\Pi$-type structure satisfies the
  \emph{$\Pi_\eta$-rule} if the equation
  \[q(p_{\Pi(A,B)},\Pi(A,B))\cdot\lambda(1_{p^*_{\Pi(A,B)}A},\app_{A,B})=1_{(\Gamma,\Pi(A,B))}\]
  is satisfied, in which case the structure will be called a
  \emph{$\Pi_\eta$-type structure}. The map on the left is the
  \emph{$\eta$-expansion map}, that is it models the map associating to
  the term $f:\Pi(A,B)$ the term $(\lambda (x:A).fx):\Pi(A,B)$ over $\Gamma$.
  Also, $(1_{p^*_{\Pi(A,B)}A},\app_{A,B})$ is specified by the following
  factorization through the pullback.
  \[\begin{tikzcd}
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.p^*_{\Pi(A,B)}B} & {\Gamma.A.B} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.A}
    \arrow["{q(p_{\Pi(A,B)},A)}"', from=3-2, to=3-3]
    \arrow["{p_A}", from=2-3, to=3-3]
    \arrow["{q(p_{\Pi(A,B)},A.B)}"', from=2-2, to=2-3]
    \arrow["{p_{p^*_{\Pi(A,B)}A}}", from=2-2, to=3-2]
    \arrow["{\app_{A,B}}", curve={height=-12pt}, from=1-1, to=2-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["{(1_{p^*_{\Pi(A,B)}A},\app_{A,B})}"{description}, dotted, from=1-1, to=2-2]
  \end{tikzcd}\]

  \wfd{(WE STILL NEED $\Pi$-EXT, WHICH REQUIRES $\Id$-TYPE STRUCTS.)}
\end{defn}

\begin{rmk}
  The definition we provided matches the one of 1808, while in 1211 they give a
  mildly different (but equivalent) one. Namely, they require
  for each pair of sections $f\colon\Gamma\rightarrow\Gamma.\Pi(A,B)$,
  $a\colon\Gamma\rightarrow\Gamma.A$ a section
  $\app_{A,B}(f,a)\colon\Gamma\rightarrow\Gamma.A.B$ with the properties
  we expressed, from which they then construct a map $\app_{A,B}$ as the
  composite
  \begin{align*}
    q(q(p_{\Pi(A,B)}\cdot & p_{p^*_{\Pi(A,B)}A},A),B)\cdot \\
    app(&(1_{\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A},p_{p^*_{\Pi(A,B)}A})),
    (1_{\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A},q(p_{\Pi(A,B)},A)) \\
        &\colon\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A\rightarrow\Gamma.A.B,
  \end{align*}
  of which we shall more explicitly describe each component. We do not actually
  need this description, but for completeness we wanted to report it.

  First we focus on $(1_{\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A},p_{p^*_{\Pi(A,B)}A})$.
  This is given as the factorization through the pullback of the cone given by the
  two maps, as we will show in a moment.
  \[\begin{tikzcd}
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B)}A})^*\Pi(A,B)} && {\Gamma.\Pi(A,B)} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.\Pi(A,B)} & \Gamma \\
    & {}
    \arrow["{p_{p^*_{\Pi(A,B)}A}}"', from=3-2, to=3-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["{p_{\Pi(A,B)}}", from=2-4, to=3-4]
    \arrow["{p_{p^*_{\Pi(A,B)}A}}", curve={height=-12pt}, from=1-1, to=2-4]
    \arrow["{p_{\Pi(A,B)}}"', from=3-3, to=3-4]
    \arrow["{p_{(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B)}A})^*\Pi(A,B)}}", from=2-2, to=3-2]
    \arrow["{q(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B)}A},\Pi(A,B))}"', from=2-2, to=2-4]
    \arrow[dotted, from=1-1, to=2-2]
  \end{tikzcd}\]

  Similarly, we obtain the other section in the argument.
  \[\begin{tikzcd}
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B)}A})^*A} & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.A} \\
    & {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.\Pi(A,B)} & \Gamma \\
    && {}
    \arrow["{p_{p^*_{\Pi(A,B)}A}}"', from=3-2, to=3-3]
    \arrow["{p_{p^*_{\Pi(A,B)}A}}"', from=2-2, to=3-2]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["{q(p_{\Pi(A,B)},A)}", curve={height=-12pt}, from=1-1, to=2-4]
    \arrow["{p_A}", from=2-4, to=3-4]
    \arrow["{p_{\Pi(A,B)}}"', from=3-3, to=3-4]
    \arrow[from=2-3, to=2-4]
    \arrow["{p_{p^*_{\Pi(A,B)}A}}", from=2-3, to=3-3]
    \arrow[from=2-2, to=2-3]
    \arrow[dotted, from=1-1, to=2-2]
  \end{tikzcd}.\]
  The map $\app$ with the arguments specified above then provides a map
  $\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A\rightarrow\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.p^*_{p^*_{\Pi(A,B)}A}A.stuffB$.
  What follows is the other map appearing in the definition of $\app_{A,B}$.
  \[\begin{tikzcd}
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B}A})^*A.stuffB} && {\Gamma.A.B} \\
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A.(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B}A})^*A} && {\Gamma.A} \\
    {\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A} & {\Gamma.\Pi(A,B)} & \Gamma
    \arrow["{q(p_{\Pi(A,B)}\cdot p_{p^*(A,B)A},A.B)}", from=1-1, to=1-3]
    \arrow["{p_B}", from=1-3, to=2-3]
    \arrow["{p_A}", from=2-3, to=3-3]
    \arrow["{p_{\Pi(A,B)}}"', from=3-2, to=3-3]
    \arrow["{p_{p^*_{\Pi(A,B)}A}}"', from=3-1, to=3-2]
    \arrow["{q(p_{\Pi(A,B)}\cdot p_{p^*(A,B)A},A)}"', from=2-1, to=2-3]
    \arrow["{p_{(p_{\Pi(A,B)}\cdot p_{p^*_{\Pi(A,B}A})^*A}}"', from=2-1, to=3-1]
    \arrow["{p_{stuffB}}"', from=1-1, to=2-1]
  \end{tikzcd}\]
\end{rmk}


\section{Structures on Iterated Context Extensions}

The aim of this section is to construct from a given contextual category $\cC$
with extra structure another contextual category $\cC^{cxt}$ with the same
structure, but where objects are iterated context extensions, compatibly with a
canonical contextual functor $\cC\rightarrow\cC^{cxt}$ defining an equivalence
on the underlying categories, thereby
generalizing our structures from simple context extensions to arbitrary ones.
Indeed, we may then take a context extension, look at it in $\cC^{cxt}$, apply
the construction and then carry it back through the equivalence. This extension
shall be heavily exploited in the final part of the thesis.

On the type theoretical side, extensions of logical rules for identity types to
contexts were first explored by Str93 and Gambino \wfd{REFS} under the name of
\emph{identity contexts} and Lumsdaine refers to them in his PhD thesis,
mentioning that it is possible to model this extension and similar ones for
$\Sigma$ and $\Pi$ types in $\cC^{cxt}$, which he constructs. At the time
Kapulkin wrote 1507,
nothing further was available in the literature and only in 1808 him and
Lumsdaine gave more details on these matters, however they still did not flesh
out the constructions in their entirety. In this section we aim to partially fix
that for $\Pi$-structures specifically, which will be the main contribution of
this work.

\begin{construction}
  \wfd{(LUMSDAINE PHD THESIS)}
  Given a contextual category $\cC$, we define a contextual category $\cC^{cxt}$
  in the following way:
  \begin{enumerate}
    \item the set $\Ob_n\cC^{cxt}$ is given by $n$-iterated context extensions
      \[\Gamma_1.\Gamma_2.\ldots.\Gamma_n\]
      in $\cC$;
    \item morphisms
      $\Gamma_1.\Gamma_2.\ldots.\Gamma_n\rightarrow\Delta_1.\Delta_2.\ldots.\Delta_m$
      are morphisms between them seen as objects of $\cC$;
    \item $*$ is the only element of $\Ob_0\cC^{cxt}$;
    \item
      $ft(\Gamma_1.\Gamma_2.\ldots.\Gamma_n.\Gamma_{n+1})=\Gamma_1.\Gamma_2.\ldots.\Gamma_n$;
    \item the map $p_{\Gamma_1.\Gamma_2.\ldots.\Gamma_n.\Gamma_{n+1}}\colon
      \Gamma_1.\Gamma_2.\ldots.\Gamma_{n+1}\rightarrow
      \Gamma_1.\Gamma_2.\ldots.\Gamma_n$ is the dependent projection exhibiting
      $\Gamma_1.\Gamma_2.\ldots.\Gamma_{n+1}$ as a context extension of
      $\Gamma_1.\Gamma_2.\ldots.\Gamma_n$ and will be denoted by
      $p_{\Gamma_{n+1}}$ unless there is ambiguity;
    \item the chosen pullbacks are given by iterating the pullbacks along the
      basic dependent projections.
  \end{enumerate}

  As we can see, any object of $\cC^{cxt}$ is isomorphic to one in
  $\Ob_1\cC^{cxt}$, that is the one which we get by looking at the associated object
  in $\cC$ and then taking the dependent projection from it to the terminal
  object, which exhibits it as a 1-iterated context extension. The isomorphism
  is then given by the map in $\cC^{cxt}$ corresponding to the identity of the
  object in $\cC$. We now specify a monad $\cC\mapsto\cC^{cxt}$ on $Cxl$.

  The unit $\cC\rightarrow\cC^{cxt}$ sends every $n$-object in $\cC$ to
  the corresponding $n$-iterated (simple) context extension and every morphism
  to the one it represents.

  Before we construct the multiplication, let's study this contextual functor.
  Every $n$-iterated
  context in $\cC^{cxt}$ is isomorphic to one in the image of the unit, namely
  the one which we get by reducing it to an iterated simple context extension,
  meaning that the functor is essentially surjective. Also, it is fully faithful
  by construction and therefore it defines an equivalence on the underlying
  categories.

  Let's construct the multiplication. An $n$-object of $(\cC^{cxt})^{cxt}$ is an
  $n$-iterated context extension where each extension is itself an iterated
  context extension in $\cC$, that is
  \[(\Gamma_1.\ldots.\Gamma_{i_1}).(\Gamma_{i_1+1}.\ldots.\Gamma_{i_2}).\ldots.(\Gamma_{i_{n-1}+1}.\ldots.\Gamma_{i_n}).\]
  Since composing dependent projections still gives dependent projections,
  seeing $\Gamma_{i_{j-1}+1}.\ldots.\Gamma_{i_j}$ as a single context extension
  $\Delta_j$ in $\cC$, we can naturally
  map the object of $(\cC^{cxt})^{cxt}$ to $\Delta_1.\ldots.\Delta_n$ in
  $\cC^{cxt}$ and, again, every morphism
  in $(\cC^{cxt})^{cxt}$ corresponds to a unique one in $\cC^{cxt}$ once we
  specify domain and codomain. By construction, this functor is again contextual
  and an equivalence of categories.

  The monad axioms follow from the fact that, essentially, both unit and counit
  are ``identities'' on objects and morphisms, which concludes our construction.
\end{construction}

We are now ready to extend the $\Pi$-structure.

\begin{construction}
  Let $\cC$ be a contextual category with a $\Pi$-structure. Our objective for
  this section is, as anticipated, to construct one on $\cC^{cxt}$. We will do
  so by induction on the length of the context extensions involved, taking the
  one from $\cC$ in case we are working with objects corresponding to simple
  extensions. Remember however that in $\cC^{cxt}$ we also have objects
  representing trivial extensions, which will require some minor attention from
  us.

  Let us consider then $\Gamma.\Delta.\Theta$ in $\cC^{cxt}$, where
  $l(\Gamma.\Delta.\Theta)=l(\Gamma.\Delta)+n=l(\Gamma)+m+n$ in $\cC$. If
  $m=0$, then we set
  \begin{align*}
    \Gamma.\Pi(\Delta,\Theta) &=\Gamma.\Theta, \\
    \app_{\Delta,\Theta} &=\id_{\Gamma.\Theta}, \\
    \lambda_{\Delta,\Theta}(b) &=b.
  \end{align*}
  Similarly, if $n=0$, then
  \begin{align*}
    \Gamma.\Pi(\Delta,\Theta) &=\Gamma, \\
    \app_{\Delta,\Theta} &=\id_{\Gamma.\Delta}, \\
    \lambda_{\Delta,\Theta}(b) &=\id_\Gamma.
  \end{align*}
  Notice that the only possible $b$ in the latter case is given by
  $\id_{\Gamma.\Theta}$. Also, the two constructions are compatible in the case
  where $m=n=0$.

  We now work with the case where $n>0$, $m=1$, thus we shall write
  $\Gamma.\Delta.\Theta=\Gamma.\Delta.B$. In the base case, $n=1$, we have
  $\Gamma.\Delta=\Gamma.A$ and therefore we simply set our structure to be the
  one in $\cC$.

  If $n-1>0$, we can write
  $\Gamma.\Delta$ as $\Gamma.\Delta'.A$ and then set
  \begin{align*}
    \Gamma.\Pi(\Delta,B)
    &=\Gamma.\Pi(\Delta'.A,B)=\Gamma.\Pi(\Delta',\Pi(A,B)) \\
    \app_{\Delta,B} &\colon
                    \Gamma.\Pi(\Delta',\Pi(A,B)).\Delta'.A
                    \xrightarrow{q(\app_{\Delta',\Pi(A,B)},p^*_{\Pi(A,B)}A)}\Gamma.\Delta'.\Pi(A,B).A
                    \xrightarrow{\app_{A,B}}\Gamma.\Delta'.A.B \\
    \lambda_{\Delta,B}(b)
    &\colon
    \Gamma
    \xrightarrow{\lambda_{\Delta',\Pi(A,B)}(\lambda_{A,B}(b))}
    \Gamma.\Pi(\Delta',\Pi(A,B)).
  \end{align*}
  The idea here is to replicate the adjunction $\Set(A\times
  B,C)\cong\Set(A,\Set(B,C))$. The map $\app_{\Delta,B}$ is then naturally
  interpreted as a sequence of partial evaluations and the phenomenon is
  commonly known as \emph{currying-uncurrying}.

  This fully specifies the construction when
  $l(\Gamma.\Delta.\Theta)=l(\Gamma.\Delta)+1$ in $\cC$, hence we shall move on
  to the case where $\Delta$ has arbitrary length and construct the necessary
  structure by inducting on the length of $\Theta$. Suppose then that
  $l(\Gamma.\Delta.\Theta)=l(\Gamma.\Delta)+n$, $n>1$, and we have already
  provided the relevant constructions up to $n-1$. We again decompose
  the context as $\Gamma.\Delta.\Theta'.B$.
  \begin{align*}
    \Gamma.\Pi(\Delta,\Theta)
    &=\Gamma.\Pi(\Delta,\Theta'.B)=\Gamma.\Pi(\Delta,\app^*_{\Delta,\Theta'}B) \\
    \app_{\Delta,\Theta}
    &\colon\Gamma.\Pi(\Delta,\Theta').\Pi(\Delta,\app^*_{\Delta,\Theta'}B).\Delta
    \xrightarrow{\app_{\Delta,\app^*_{\Delta,\Theta'}B}}
    \Gamma.\Pi(\Delta,\Theta').\Delta.\app^*_{\Delta,\Theta'}B
    \xrightarrow{q(\app_{\Delta,\Theta'},B)}
    \Gamma.\Delta.\Theta'.B \\
    \lambda_{\Delta,\Theta}(b)
    &\colon\Gamma
    \xrightarrow{\lambda_{\Delta,\Theta'}(p_B\cdot b)}
    \Gamma.\Pi(\Delta,\Theta')
    \xrightarrow{\lambda_{p^*_{\Pi(\Delta,\Theta')}\Delta,\app^*_{\Delta,\Theta'}B}(p_{\Pi(\Delta,\Theta')}^*a)}
    \Gamma.\Pi(\Delta,\Theta').\Pi(\Delta,\app^*_{\Delta,\Theta'}B)
  \end{align*}

  Our definition of $\lambda_{\Delta,\Theta}$ makes use of the map
  $p^*_{\Pi(\Delta,\Theta')}a$, which comes from the diagram
  \[\begin{tikzcd}
    {\Gamma.\Pi(\Delta,\Theta').p^*_{\Pi(\Delta,\Theta')}\Delta.\app^*_{\Delta,\Theta'}B}
    & {\Gamma.\Delta.\Theta'.B} \\
    & {\Gamma.\Delta.\Theta'} \\
    {\Gamma.\Pi(\Delta,\Theta').p^*_{\Pi(\Delta,\Theta')}\Delta} & {\Gamma.\Delta} \\
    {\Gamma.\Pi(\Delta,\Theta')} & \Gamma
    \arrow["{p_B}"', from=1-2, to=2-2]
    \arrow["{p_{\Theta'}}"', from=2-2, to=3-2]
    \arrow["{p_{\Delta}}", from=3-2, to=4-2]
    \arrow["{p_{\app^*_{\Delta,\Theta'}B}}", from=1-1, to=3-1]
    \arrow["{p_{\Pi(\Delta,\Theta')}}"', from=4-1, to=4-2]
    \arrow["{p_{p^*_{\Pi(\Delta,\Theta')}\Delta}}"', from=3-1, to=4-1]
    \arrow["{q(p_{\Pi(\Delta,\Theta')},\Delta)}"', from=3-1, to=3-2]
    \arrow["{\app_{\Delta,\Theta'}}", from=3-1, to=2-2]
    \arrow["{q(\app_{\Delta,\Theta'},B)}", from=1-1, to=1-2]
    \arrow["a"', curve={height=24pt}, from=3-2, to=1-2]
    \arrow["{q(p_{\Pi(\Delta,\Theta')},\Delta)^*a}=p_{\Pi(\Delta,\Theta')}^*a", curve={height=-24pt}, from=3-1, to=1-1]
  \end{tikzcd},\]
  where the construction works because (as we shall verify in the next
  proposition) the triangle commutes.

  Here we construct the actual $\lambda_{\Delta,\Theta}$. First, we consider a
  section $p_B\cdot b\colon\Gamma.\Delta\rightarrow\Gamma.\Delta.\Theta'$, to
  which we apply $\lambda_{\Delta,\Theta'}$ to get
  $\lambda_{\Delta,\Theta'}\colon\Gamma\rightarrow\Gamma.\Pi(\Delta,\Theta')$.
  After this, we look at the factorization
  \[\begin{tikzcd}[column sep=large]
    {\Gamma.\Delta} \\
    & {\Gamma.\Delta.\Pi(\Delta,\Theta').\epsilon^*_{\Gamma.\Delta.\Theta'}B} & {\Gamma.\Delta.\Theta'.B} \\
    & {\Gamma.\Delta.\Pi(\Delta,\Theta')} & {\Gamma.\Delta.\Theta'} \\
    & {\Gamma.\Delta} & {}
    \arrow["{p_{\Pi(\Delta,\Theta'})}", from=3-2, to=4-2]
    \arrow[curve={height=18pt}, Rightarrow, no head, from=1-1, to=4-2]
    \arrow["{(\lambda_{\Delta,\Theta'}(p_B\cdot b),q(\epsilon_{\Delta,\Theta'},B))}"{description, pos=0.7}, dotted, from=1-1, to=2-2]
    \arrow[from=2-2, to=3-2]
    \arrow["{\lambda_{\Delta,\Theta'}(p_B\cdot b)}"{description, pos=0.8}, curve={height=12pt}, from=1-1, to=3-2]
    \arrow["b", curve={height=-12pt}, from=1-1, to=2-3]
    \arrow["{p_B}", from=2-3, to=3-3]
    \arrow["{q(\epsilon_{\Delta,\Theta'},B)}"', from=2-2, to=2-3]
    \arrow["{\epsilon_{\Delta,\Theta'}}"', from=3-2, to=3-3]
  \end{tikzcd},\]
  getting then
  $\lambda_{\Delta,\Pi(\Delta,\Theta').\epsilon^*_{\Delta,\Theta'}B}
  (\lambda_{\Delta,\Theta'} (p_B\cdot b),q(\epsilon_{\Delta,\Theta'},B))
  \colon\Gamma
  \rightarrow\Gamma.\Pi(\Delta,\Pi(\Delta,\Theta').\epsilon^*_{\Gamma.\Delta.\Theta'}B)$.

  Rewriting
  $\Gamma.\Pi(\Delta,\Pi(\Delta,\Theta').\epsilon_{\Gamma.\Delta.\Theta'}B)$ as
  $\Gamma.\Pi(\Delta,\Pi(\Delta,\Theta')).
  \Pi(\Delta,\app^*_{\Delta,\Pi(\Delta,\Theta')}\epsilon^*_{\Gamma.\Delta.\Theta'}B)$,
  we see that we can postcompose the section with the map
  $q(\Gamma.\Pi(\Delta,
  \epsilon_{\Gamma.\Delta.\Theta'}),\Pi(\Delta,\app^*_{\Delta,\Theta'}B))\colon
  \Gamma.\Pi(\Delta,\Pi(\Delta,\Theta')).\Pi(\Delta,\app^*_{\Delta,\Pi(\Delta,\Theta')}\epsilon^*_{\Gamma.\Delta.\Theta'}B)
  \rightarrow\Gamma.\Pi(\Delta,\Theta').\Pi(\Delta,\app^*_{\Delta,\Theta'}B)$,
  which gives us our $\lambda_{\Delta,\Theta}(b)$.

  Given $a\colon\Gamma\rightarrow\Gamma.\Delta$,
  $f\colon\Gamma.\Delta\rightarrow\Gamma.\Delta.\Theta$, we construct
  $\app(f,a)$ as in the definition of $\Pi$-structures.

  This fully specifies the data needed for a $\Pi$-structure on $\cC^{cxt}$,
  however we still have to check that it is indeed one.
\end{construction}

\begin{prop}
  Given a contextual category with a $\Pi$-structure $\cC$, the above data
  defines a $\Pi$-structure on $\cC^{cxt}$ which is compatible with the natural
  contextual functor $\cC\rightarrow\cC^{cxt}$. Also, if the original
  $\Pi$-structure has the $\Pi_\eta$ property, the same goes for the one on
  $\cC^{cxt}$.
\end{prop}
\begin{proof}
  We have to
  show that it is a $\Pi$-structure, which we will do inductively by verifying
  that at every step our proposed construction maintains the desired properties.
  The compatibility with the contextual functor will then follow directly from
  the way we defined the base case.

  Let's consider an object $\Gamma.\Delta.\Theta$ in $\cC^{cxt}$. The only
  interesting case is the one where both $\Delta$ and $\Theta$
  specify non-trivial context extensions in $\cC$ and at least one of them is
  not basic: indeed, the desired properties in the other cases are either
  trivial or follow directly from the fact that they hold in $\cC$.

  We start as before by working on $\Delta$, supposing that
  $\Gamma.\Delta.\Theta=\Gamma.\Delta.B=\Gamma.\Delta'.A.B$ and that
  the desired properties for context extensions over $\Gamma$ of length
  up to $l(\Gamma.\Delta')-l(\Gamma)$.
  We can then write
  \begin{align*}
    p_B\cdot\app_{\Delta,B}
    &=p_B\cdot
    \app_{A,B}\cdot
    q(\app_{\Delta',\Pi(A,B)},p^*_{\Pi(A,B)}A) \\
    &=q(p_{\Pi(A,B)},A)\cdot
    q(\app_{\Delta',\Pi(A,B)},p^*_{\Pi(A,B)}A) \\
    &=q(p_{\Pi(A,B)}\cdot\app_{\Delta',\Pi(A,B)},A) \\
    &=q(q(p_{\Pi(\Delta',\Pi(A,B))},\Delta'),A) \\
    &=q(p_{\Pi(\Delta',\Pi(A,B))},\Delta'.A) \\
    &=q(p_{\Pi(\Delta,B)},\Delta) \\
    p_B\cdot\app(f,a)
    &=p_B\cdot
    \app_{\Pi(\Delta,B)}\cdot
    p^*_{\Pi(\Delta,B))}a\cdot
    f \\
    &=q(p_{\Pi(\Delta,B)},\Delta)\cdot
    p^*_{\Pi(\Delta,B)}a\cdot
    f \\
    &=a\cdot
    p_{\Pi(\Delta,B))}\cdot
    f \\
    &=a \\
    \app(\lambda_{\Delta,B}(b),a)
    &=\app_{A,B}\cdot
    q(\app_{\Delta',\Pi(A,B)},A)\cdot
    p^*_{\Pi(\Delta',\Pi(A,B))}a\cdot
    \lambda_{\Delta,B}(b) \\
    &=\app_{A,B}\cdot
    q(\app_{\Delta',\Pi(A,B))},A)\cdot
    p^*_{\Pi(\Delta',\Pi(A,B))}a\cdot
    \lambda_{\Delta',\Pi(A,B)}(\lambda_{A,B}(b)) \\
    &=\app_{A,B}\cdot
    q(\app_{\Delta',\Pi(A,B))},A)\cdot
    \app() \\
    other attempt...
    &=b\cdot a \\
    &=b\cdot
    a\cdot
    p_{\Pi(\Delta,B)}\cdot
    \lambda_{\Delta,B}(b) \\
    &=b\cdot
    q(p_{\Pi(\Delta,B)},\Delta)\cdot
    p^*_{\Pi(\Delta,B)}a\cdot
    \lambda_{\Delta,B}(b) \\
    &= \\
    \app(\lambda_{\Delta,B}(b),p_A\cdot a)
    &=\app(\lambda_{\Delta',\Pi(A,B)}(\lambda_{A,B}(b)),p_A\cdot a) \\
    &=\lambda_{A,B}(b)\cdot p_A\cdot a \\
    &= ??? \\
    p_{\Pi(\Delta,B)}\cdot\lambda_{\Delta,B}(b)
    &=p_{\Pi(\Delta',\Pi(A,B))}\cdot
    \lambda_{\Delta',\Pi(A,B)}(\lambda_{A,B}(b)) \\
    &=\id_\Gamma.
  \end{align*}
  \wfd{PLEASE VERIFY, LIKELY WRONG}

  We now check inductively on the length of $\Theta$. \wfd{(WE STILL HAVE TO
  FIND THE RIGHT $\lambda$!!!)}
  \begin{align*}
    p_{\Theta}\cdot\app_{\Delta,\Theta}
    &=p_{\Theta'}\cdot
    p_B\cdot
    q(\app_{\Delta,\Theta'},B)\cdot
    \app_{\Delta,\app^*_{\Delta,\Theta'}B} \\
    &=p_{\Theta'}\cdot
    \app_{\Delta,\Theta'}\cdot
    p_{\app^*_{\Delta,\Theta'}B}\cdot
    \app_{\Delta,\app^*_{\Delta,\Theta'}B} \\
    &=q(p_{\Pi(\Delta,\Theta)},\Delta)\cdot
    q(p_{\Pi(\Delta,\app^*_{\Delta,\Theta'}B)},\Delta) \\
    &=q(p_{\Pi(\Delta,\Theta')}\cdot
    p_{\Pi(\Delta,\app^*_{\Delta,\Theta'}B)},\Delta) \\
    &=q(p_{\Pi(\Delta,\Theta').\Pi(\Delta,\app^*_{\Delta,\Theta'}B)},\Delta) \\
    &=q(p_{\Pi(\Delta,\Theta)},\Delta) \\
    p_\Theta\cdot\app(f,a)
    &=p_\Theta\cdot\app_{\Pi(\Delta,\Theta)}\cdot p^*_{\Pi(\Delta,\Theta)}a\cdot f \\
    &=q(p_{\Pi(\Delta,\Theta)},\Delta)\cdot p^*_{\Pi(\Delta,\Theta)}a\cdot f \\
    &=a\cdot p_{\Pi(\Delta,\Theta)}\cdot f \\
    &=a \\
    need \lambda first...
  \end{align*}

  To conclude the proof one would still need to verify that the construction is
  compatible with context substitution.
\end{proof}

\begin{construction}
  Given a map $f\colon\Gamma.\Delta.\Psi\rightarrow\Gamma.\Delta.\Theta$ over
  $\Gamma.\Delta$, we shall construct a map
  $\Gamma.\Pi(\Delta,f)\colon\Gamma.\Pi(\Delta,\Psi)\rightarrow\Gamma.\Pi(\Delta,\Theta)$
  over $\Gamma$ in the second argument of $\Pi$ corresponding to postcomposition
  by $f$.

  We do so by looking at the commutative diagram
  \[\begin{tikzcd}
    {\Gamma.\Pi(\Delta,p^*_\Delta\Psi).p^*_{\Pi(\Delta,p^*_\Delta\Psi)}\Delta} && {\Gamma.\Delta.p^*_\Delta\Psi} \\
    & {\Gamma.\Pi(\Delta,p^*_\Delta\Psi).\Delta.\Theta} & {\Gamma.\Delta.\Theta} \\
    & {\Gamma.\Pi(\Delta,p^*_\Delta\Psi).p^*_{\Pi(\Delta,p^*_\Delta\Psi)}\Delta} & {\Gamma.\Delta}
    \arrow["{q(p_{\Pi(\Delta,p^*_\Delta\Psi)},\Delta)}"', from=3-2, to=3-3]
    \arrow["{p_\Psi}"', from=2-3, to=3-3]
    \arrow["{q(q(p_{\Pi(\Delta,p^*_\Delta\Psi)},\Delta),\Theta)}", from=2-2, to=2-3]
    \arrow["{p_{p^*_{p^*_\Delta\Theta}\Psi}}", from=2-2, to=3-2]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["f", from=1-3, to=2-3]
    \arrow["{p_{p^*_\Delta\Psi}}", curve={height=-24pt}, from=1-3, to=3-3]
    \arrow["{\app_{\Delta,p^*_\Delta\Psi}}", from=1-1, to=1-3]
    \arrow["{(1_{p^*_{\Pi(\Delta,p^*_\Delta\Psi)}\Delta},f\cdot
    \app_{\Delta,p^*_\Delta\Psi})}"{pos=1}, from=1-1, to=2-2, dotted]
  \end{tikzcd}\]
  and then applying $\lambda_{\Delta,\Theta}$ to the map given by the universal
  property of the pullback, which gives us a section
  $\lambda_{\Delta,\Theta}(1_{p^*_{\Pi(\Delta,p^*_\Delta\Psi)}\Delta},f\cdot\app_{\Delta,p^*_\Delta\Psi})\colon\Gamma.\Pi(\Delta,p^*_\Delta\Psi)\rightarrow\Gamma.\Pi(\Delta,p^*_\Delta\Psi).\Pi(\Delta,\Theta)$.
  All we have to do now is post-compose with
  $q(p_{\Pi(\Delta,\Psi)},\Pi(\Delta,\Theta))$.
\end{construction}

We shall also need the following lemma in the proof of FINAL THEOREM.

\begin{lem}
  Given an iterated context extension $\Gamma.\Delta.\Theta.\Psi$ in a
  contextual category with $\Pi$-types $\cC$, the contexts
  \[\Gamma.\Pi(\Delta,\Theta.\Psi),\quad\Gamma.\Pi(\Delta,\Theta).\Pi(p^*_{\Pi(\Delta,\Theta)}\Delta,\app^*_{\Delta,\Theta}\Psi)\]
  are equal in $\cC$. Also,
  $\Gamma.\Pi(\Delta,p_{\Psi})=p_{\Pi(\Delta,\app^*_{\Delta,\Theta}\Psi)}$.
\end{lem}
\begin{proof}
  For the first claim, it is enough to notice that the two contexts reduce to
  the same one in $\cC$ after applying the inductive construction we defined on
  $\cC^{cxt}$ to reduce $\Psi$.

  For the second claim instead we consider the chain of equalities
  \begin{align*}
    \Gamma.\Pi(\Delta,p_{\Psi})
    &=q(p_{\Pi(\Delta,\Theta.\Psi)},\Pi(\Delta,\Theta))\cdot
    \lambda_{\Delta,\Theta}(1_{p^*_{\Pi(\Delta,\Theta)}\Delta},p_\Psi\cdot\app_{\Delta,\Theta.\Psi}) \\
    &=p_{\Pi(\Delta,\app^*_{\Delta,\Theta})}\cdot
    p_{\Pi(\Delta,\Theta)}\cdot
    \lambda_{\Delta,\Theta}(1_{p^*_{\Pi(\Delta,\Theta)}\Delta},p_\Psi\cdot\app_{\Delta,\Theta.\Psi}) \\
    &=p_{\Pi(\Delta,\app^*_{\Delta,\Theta})}.
  \end{align*}
  \wfd{(PLEASE CHECK)}
\end{proof}

We now do the same for an $\Id$-structure on a contextual category.

\begin{construction}
  Let $\cC$ be a contextual category with an $\Id$-structure. Given a dependent
  context $p_\Delta\colon\Gamma.\Delta\rightarrow\Gamma$ with
  $l(\Gamma.\Delta)=l(\Gamma)+n$ in $\cC$ we proceed by induction on $n$.

  If $n=0$, then
  \begin{align*}
    \Gamma.\Id_\Delta &=\Gamma, \\
    r_\Delta &=1_\Gamma, \\
    J_{\Theta,C,d} &=d.
  \end{align*}

  If $n=1$,
  \begin{align*}
    \Gamma.\Id_A &=\Gamma.\Id_A, \\
    r_A &=r_A, \\
    J_{\Theta,C,d} &=J(\Theta,C,d),
  \end{align*}
  where the objects on the right are the ones given by the $\Id$-structure on
  $\cC$.

  If $n>1$, assuming to have extended the $\Id$-structure to shorter context
  extensions in $\cC$, we write instead
  \begin{align*}
    \Gamma.\Id_{\Delta} &=\Gamma.\Id_{\Delta'.A}=\Gamma.\Id_{\Delta'}.\Id_A \\
    r_{\Delta} &= q(,)\cdot r_A
  \end{align*}
\end{construction}

\begin{prop}\cite[Prop.\ 3.3.1]{Gar09b}
  Given a contextual category with an $\Id$-structure $\cC$, $\cC^{cxt}$ also
  carries a natural $\Id$-structure compatible with the contextual functor
  $\cC\rightarrow\cC^{cxt}$ as described in REFS 0808.
\end{prop}

\begin{lem}\cite[Lemma 2.28]{1808}
  Given a contextual category with $\Id$, $\Pi_\eta$ structures and function
  extensionality $\cC$, the latter can also be extended to $\cC^{cxt}$
  compatibly with the $\Id$ and $\Pi$ structures specified above. In particular,
  if we have two sections
  $b,b'\colon\Gamma.\Delta\rightarrow\Gamma.\Delta.\Theta$ and a homotopy
  $h:b\sim b'$, that is a section
  $h\colon\Gamma.\Delta\rightarrow\Gamma.\Delta.(b,b')^*\Id_{\Theta}$,
  then there is also a homotopy between $\lambda_{\Delta,\Theta}(b)$ and
  $\lambda_{\Delta,\Theta}(b')$ and these constructions are functorial in $\cC$.
\end{lem}

\begin{cor}\cite[Lemma 2.29]{1808}
  Under the conditions of the previous theorem, if
  $f\colon\Gamma.\Delta.\Theta\rightarrow\Gamma.\Delta.\Psi$ is
  bi-invertible over $\Gamma.\Delta$, then the same goes for the induced map
  $\Gamma.\Pi(\Delta,\Theta)\rightarrow\Gamma.\Pi(\Delta,\Psi)$.
\end{cor}

\wfd{(WE COULD ALSO REFER TO 5.9 FROM 1203.3253, WHERE THEY GIVE A PROOF FOR
TRIBES WHICH MAY BE ADAPTED; THM 4.8 FROM THERE TELLS US THAT THEY ARE
CANONICALLY SPLIT TYPE-THEORETIC FIBRATION CATEGORIES, WHICH ALLOWS US TO APPLY
THE RESULT)}

\wfd{(MAYBE INTRODUCE THE LAST TWO RESULTS LATER? THEY HOLD FOR SIMPLE
EXTENSIONS IN ANY CONTEXTUAL CATEGORY, HENCE THEY ALSO HOLD FOR SIMPLE
EXTENSIONS IN THE ITERATED CONTEXTUAL CAT AND FOR ITERATED EXTENSIONS IN ANY
CONTEXTUAL CAT. ALSO, WE NEED TO SAY WHAT BI-INVERTIBLE MAPS ARE, WHICH I WOULD LIKE
TO DO LATER; LET'S KEEP THIS SECTION ABOUT STUFF STRICTLY ABOUT ITERATED
CONTEXTS)}

\begin{rmk}
  In Lumsdaine's PhD thesis it is noted that the lift of $\Id$ and $\Pi$
  structures is not compatible with the monad we provided earlier because they
  are not compatible with the multiplication. On the other
  hand, with a strategy along the line of the one we presented for
  $\Pi$-structures we can also lift $\Sigma$-structures compatibly with the
  monad, meaning that $(-)^{cxt}$ restricts to one on $Cxl_\Sigma$.
\end{rmk}

\section{Localizations of \texorpdfstring{$\infty$}{âˆž}-Categories}

To prove that localizing a categorical model of type theory we get a locally
cartesian closed $\infty$-category we need a theory of localizations. We shall
provide one in the general context of $\infty$-categories as developed by
Cisinski in \emph{Higher Categories and Homotopical Algebra} with the aim of
proving \cite[Thm.\ 7.6.16]{Cis19}, which will do the heavy lifting in showing
the desired result. Those familiar with the theory may skip the entire chapter
while keeping in mind yadda yadda \wfd{(LIST THE MAJOR RESULTS)}.

\begin{defn}
  Let $X$ be a simplicial set and $W\subset X$ a simplicial subset. Given an
  $\infty$-category $\cC$, we define $\Home_W(X,\cC)$ to be the full simplicial
  subset of $\Home(X,\cC)$ whose objects are the morphisms $f\colon
  X\rightarrow\cC$ sending the 1-simplices in $W$ to isomorphisms.
\end{defn}

\begin{rmk}
  The above definition induces a canonical pullback square
  \[\begin{tikzcd}
    {\Home_W(X,\cC)} & {\Home(X,\cC)} \\
    {\Home_W(W,\cC)} & {\Home(W,\cC)}
    \arrow[from=1-1, to=2-1]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=1-2]
    \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
  \end{tikzcd}\]
  given by the inclusion $W\rightarrow X$.
\end{rmk}

\begin{defn}
  Given an $\infty$-category $\cC$ and $W\subset\cC$, a \emph{localization of
  $\cC$ by $W$} is a functor $\gamma\colon\cC\rightarrow L(\cC)$ such that:
  \begin{enumerate}
    \item $L(\cC)$ is an $\infty$-category;
    \item $\gamma$ sends the 1-simplices of $W$ to isomorphisms in $L(\cC)$;
    \item for any $\infty$-category $\cD$ there is an equivalence of
      $\infty$-categories
      \[\Home(L(\cC),\cD)\rightarrow\Home_W(\cC,\cD)\]
      given by precomposing with $\gamma$.
  \end{enumerate}
\end{defn}

\wfd{(CISINSKI DOES NOT ASK FOR $\cC$ TO BE AN $\infty$-CATEGORY. SHOULD WE
BE LESS GENERAL AS WE HAVE DONE?)}

\begin{prop}\label{exuniq}
  Given an $\infty$-category $\cC$ and a subsimplicial set $W$, the localization
  of $\cC$ by $W$ always exists and it is essentially unique.
\end{prop}
\begin{proof}
  We begin by proving that a localization exists in the case where $W=\cC$.

  In this context, $\Home_W(\cC,\cD)\cong\Home(\cC,\cD^{\cong})$ canonically,
  where $\cD^{\cong}$ is the maximal subgroupoid of $\cD$.
  Factoring $\cC\rightarrow\Delta^0$ in the Kan model structure, we find an
  anodyne map $\gamma\colon\cC\rightarrow L(\cC)$.

  Remember that for any anodyne map $A\rightarrow B$ we get a trivial fibration
  $\Home(B,\cD^{\cong})\rightarrow\Home(A,\cD^{\cong})$. Looking then at the
  commutative diagram
  \[\begin{tikzcd}
    {\Hom(L(\cC),\cD^{\cong})} & {\Hom_W(\cC,\cD^{\cong})} \\
    {\Home(L(\cC),\cD)} & {\Home_W(\cC,\cD)}
    \arrow["\gamma^*", "\sim"', two heads, from=1-1, to=1-2]
    \arrow[from=1-1, to=2-1]
    \arrow["{\gamma^*}"', from=2-1, to=2-2]
    \arrow["\cong", from=1-2, to=2-2]
    \arrow["\cong"', from=1-1, to=2-1]
  \end{tikzcd},\]
  by the 2-out-of-3 property we see that the lower $\gamma^*$ is an equivalence.
  
  We now move on to the general case. First of all, notice that as a particular
  case of the previous one we get that localizing $\Delta^1$ at its non-trivial
  morphism we obtain $\Delta^1\rightarrow J=L(\Delta^1)\sim\Delta^0$. Taking
  then $W\subset\cC$, we consider the commutative diagram
  \[\begin{tikzcd}
    {\coprod_{f\in W_1}\Delta^1} & \cC \\
    {\coprod_{f\in W_1}J} & {\cC'} \\
    && {L(\cC)}
    \arrow[from=1-1, to=1-2]
    \arrow[from=1-1, to=2-1]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=2-1]
    \arrow["\sim"', hook, from=2-2, to=3-3]
    \arrow["\gamma", curve={height=-12pt}, from=1-2, to=3-3]
    \arrow["\lrcorner"{anchor=center, pos=0.125, rotate=180}, draw=none, from=2-2, to=1-1]
  \end{tikzcd},\]
  where $\cC'\rightarrow L(\cC)$ is an inner anodyne map obtained by taking the
  fibrant replacement of $\cC'$ in the Joyal model structure. This can be done
  functorially via the small object argument.

  For any $\infty$-category $\cD$, we get a trivial fibration
  $\Home(L(\cC),\cD)\rightarrow\Home(\cC',\cD)$ and a pullback square
  \[\begin{tikzcd}
    {\Home(\cC',\cD)} & {\Home(\cC,\cD)} \\
    {\Pi_{f\in W_1}\Home(J,\cD)} & {\Pi_{f\in W_1}\Home(\Delta^1,\cD)}
    \arrow[from=1-2, to=2-2]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-1, to=2-1]
    \arrow[from=1-1, to=1-2]
  \end{tikzcd},\]
  which together with the pullback
  \[\begin{tikzcd}
    {\Home_W(\cC,\cD)} & {\Home(\cC,\cD)} \\
    {\Pi_{f\in W_1}\Home(\Delta^1,\cD^{\cong})} & {\Pi_{f\in W_1}\Home(\Delta^1,\cD)}
    \arrow[from=1-2, to=2-2]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-1, to=2-1]
    \arrow[from=1-1, to=1-2]
  \end{tikzcd}\]
  implies by pasting that
  \[\begin{tikzcd}
    {\Home(\cC',\cD)} & {\Home_W(\cC,\cD)} \\
    {\Pi_{f\in W_1}\Home(J,\cD)} & {\Pi_{f\in W_1}\Home(\Delta^1,\cD^{\cong})}
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=1-2]
    \arrow[from=1-1, to=2-1]
    \arrow["\sim", two heads, from=2-1, to=2-2]
    \arrow[from=1-2, to=2-2]
  \end{tikzcd}\]
  is also a pullback and therefore the upper arrow is a trivial fibration.
  Composing it with the other one we get
  $\gamma^*\colon\Home(L(\cC),\cD)\rightarrow\Home_W(\cC,\cD)$, which is then a
  trivial fibration and therefore an equivalence of $\infty$-categories.

  7.1.4 Observe that, through this construction, one can always construct
  $L(\cC)$ so that $\gamma$ is a bijection on objects because $\cC'\rightarrow
  L(\cC)$ is an inner anodyne extension and therefore a retract of a countable
  composition of sums of pushouts of maps which are the identity on objects,
  that is the inner horn inclusions.

  We now move on to proving that the localization is essentially unique. For
  this, we notice that $\gamma$ establishes then an isomorphism between
  $\pi_0(k(\Home_W(\cC,-)))$ and $\pi_0(\Home(L(\cC),-))=ho(\sSet)(L(\cC),-)$
  with respect to the Joyal model structure, thus by Yoneda $(L(\cC),\gamma)$ is
  unique up to unique isomorphism in $ho(\sSet)$ and up to a contractible space
  of equivalences in $\sSet$.
\end{proof}

\begin{rmk}\label{715}
  7.1.5

  In this context, we may define $\overline{W}$, the saturation of $W$ in $\cC$,
  as the cartesian square

  such that $\overline{W}$ is precisely the maximal simplicial subset of $\cC$
  whose morphisms are the ones which become invertible in $L(\cC)$, that is
  $\overline{W}\cong k(L(\cC))\times_{L(\cC)}\cC$ canonically.

  We have then inclusions $Sk_1(W)\subset W\subset\overline{W}$ and, for any
  $\infty$-category $\cD$, this induces equalities
  \[\Home_{Sk_1(W)}(\cC,\cD)=\Home_{W}(\cC,\cD)=\Home_{\overline{W}}(\cC,\cD),\]
  implying that $(L(\cC),\gamma)$ is also the localization of $\cC$ by $Sk_1(W)$
  and the one by $\overline{W}$, however the inclusion
  $\overline{W}\rightarrow\cC$ is a fibration in the Joyal model category as it
  is the pullback of one, implying that $\overline{W}$ is itself an
  $\infty$-category.

  We shall say that $\cC$ is saturated if the canonical inclusion
  $W\rightarrow\overline{W}$ is an isomorphism of $\infty$-categories.
\end{rmk}

\begin{rmk}
  7.1.6

  The functor $ho(\cC)\rightarrow ho(L(\cC))$ exhibits $ho(L(\cC))$ as the
  1-categorical localization of $\cC$ at $\Arr(\tau(W))$, as can be seen by
  using the universal property.

  On the other hand, given a 1-category $\cC$ and localizing at a set of
  morphisms $W$, not necessarily the induced map $L(N(\cC))\rightarrow
  N(L(\cC))$ is an isomorphism. Indeed, $L(N(\cC))$ can have much better
  properties, as can be seen for example from \ref{756}, and in fact localizing
  1-categories after taking their nerves gives every $\infty$-category as shown
  in \cite[Prop.\ 7.3.15]{Cis19}.
\end{rmk}

\begin{prop}
  7.1.9

  Given a universe $\bfU$ and $W$ a simplicial subset of a $\bfU$-small
  $\infty$-category $\cC$, let $\gamma\colon\cC\rightarrow L(\cC)$ be the
  associated localization. Then the functor
  $\gamma^*\colon\Home(L(\cC)^{\op},\cS)\rightarrow\Home(\cC^{\op},\cS)$ is
  fully faithful and its essential image consists of all presheaves
  $F\colon\cC^{\op}\rightarrow\cS$ sending maps $u\colon x\rightarrow y$ in $W$
  to invertible maps $u^*\colon Fy\rightarrow Fx$ in $\cS$.
\end{prop}
\begin{proof}
  The map $\gamma$ gives us a morphism
  \[\gamma^*\colon\Home(L(\cC)^{\op},\cS)\simeq\Home_{W^{\op}}(\cC^{\op},\cS)\rightarrow\Home(\cC^{\op},\cS),\]
  which has a left adjoint $\gamma_!$ and a right adjoint $\gamma_*$. Now, or
  any presheaf $F\colon L(\cC)^{\op}\rightarrow\cS$, the unit map
  $F\rightarrow\gamma_*\gamma^*F$ is invertible and, by adjunction, the same
  goes for the counit map $\gamma_!\gamma^*F\rightarrow F$, which means that
  $u^*$ is fully faithful. On the other hand, given a presheaf
  $F\colon\cC^{\op}\rightarrow\cS$ sending 1-simplices in $W$ to invertible maps,
  the counit $\gamma^*\gamma_*F\rightarrow F$ and the unit
  $F\rightarrow\gamma^*\gamma_!F$ are both invertible since the restrictions of
  these adjunctions to $\Home_{W^{\op}}(\cC^{\op},\cS)$ form adjoint
  equivalences of $\infty$-categories as $\gamma^*$ is an equivalence.
\end{proof}

\begin{prop}\label{7110}
  7.1.10

  Given an $\infty$-category $\cC$ and a simplicial subset $W$, the localization
  functor $\gamma\colon\cC\rightarrow L(\cC)$ is final and cofinal. In
  particular, if $e\colon\Delta^0\rightarrow\cC$ encodes a final or a cofinal
  object, so does $\gamma(e)$.
\end{prop}
\begin{proof}
  First of all, the functor $\gamma^{\op}$ is also a localization, so it
  suffices to prove that $\gamma$ is final. To do this, first we fix a universe
  $\bfU$ such that $\cC$ is $\bfU$-small and then we remember that there
  is an adjunction
  $\adjunction{\gamma^*}{\Home(L(\cC),\cS)}{\Home(\cC,\cS)}{\gamma_*}$. Since
  $\gamma^*$ induces an equivalence when restricting the codomain to
  $\Home_W(\cC,\cS)$, we know that it is fully faithful, thus the unit of the
  adjunction is invertible, hence $1\cong\gamma_*\gamma^*$. This gives us that
  \[\lim_{\cC}F\cong\lim_{\cC}\gamma_*\gamma^*F\cong\lim_{L(\cC)}\gamma^*F,\]
  for any presheaf $F\colon\cC\rightarrow\cS$, which is enough to prove that
  $\gamma$ is final (\cite[Thm.\ 6.4.5]{Cis19}).
\end{proof}

\begin{prop}
  7.1.11
  Let's fix a universe $\bfU$, a $\bfU$-small $\infty$-category $\cC$ and a
  simplicial subset $W$. Consider then a functor $f\colon\cC\rightarrow\cD$,
  where $X$ is a small $\infty$-category. Then $f$ exhibits $\cD$ as the
  localization of $\cC$ by $W$ if and only if the following conditions hold:
  \begin{enumerate}
    \item the functor $f$ sends the 1-simplices of $W$ to invertible maps of
      $\cD$;
    \item the functor $f$ is essentially surjective;
    \item the functor $f^*$ induces an equivalence of $\infty$-categories
      \[f^*\colon\Home(\cD^{\op},\cS)\rightarrow\Home_{W^{\op}}(\cC^{\op},\cS).\]
  \end{enumerate}
\end{prop}
\begin{proof}
  One implication is trivial (for (2) look at the construction in \ref{exuniq}).
  For the converse, let's pick a localization $\gamma\colon\cC\rightarrow
  L(\cC)$ and, through condition (1), we get a factorization $g\colon
  L(\cC)\rightarrow\cD$ such that $g\cdot\gamma\cong f$, giving us a triangle
  \[\begin{tikzcd}
    {\Home(\cD^{\op},\cE)} && {\Home(L(\cC)^{\op},\cE)} \\
                           & {\Home_{W^{\op}}(\cC^{\op},\cE)}
    \arrow["{g^*}", from=1-1, to=1-3]
    \arrow["{f^*}"', from=1-1, to=2-2]
    \arrow["{\gamma^*}", from=1-3, to=2-2]
  \end{tikzcd}\]
  commuting up to $J$-homotopy for any $\infty$-category $\cE$. Picking
  $\cE=\cS$, $\gamma^*$ and $f^*$ are equivalences
  of $\infty$-categories, the latter by (3). It follows by 2-out-of-3 that $g^*$
  is one too, and therefore the same applies to its left adjoint $g_!$, which is
  then fully faithful. This is equivalent to $g$ being fully faithful \wfd{(FUN
  THEOREM, MAYBE STATE IT AT LEAST 6.1.5)} and, since
  $f$ is essentially surjective by (2), the same goes for $g$. It follows that
  $g$ is an equivalence of $\infty$-categories.
\end{proof}

\begin{prop}\label{7114}
  7.1.14

  Let $f\colon\cC\rightarrow\cD$ be a functors between $\infty$-categories with
  a right adjoint $g\colon\cD\rightarrow\cC$ and suppose that we are given
  simplicial subsets $V\subset\cC$, $W\subset\cD$ such that $f(V)\subset W$,
  $g(W)\subset V$. Then we can lift them to an adjunction
  $\adjunction{\overline{f}}{L(\cC)}{L(\cD)}{\overline{g}}$ such that the
  diagrams
  \[\begin{tikzcd}
    \cC & \cD \\
    {L(\cC)} & {L(\cD)}
    \arrow["{\gamma_\cD}", from=1-2, to=2-2]
    \arrow["{\gamma_\cC}"', from=1-1, to=2-1]
    \arrow["{\overline{f}}"', from=2-1, to=2-2]
    \arrow["f", from=1-1, to=1-2]
  \end{tikzcd},
  \quad
  \begin{tikzcd}
    \cD & \cC \\
    {L(\cD)} & {L(\cC)}
    \arrow["{\gamma_\cC}", from=1-2, to=2-2]
    \arrow["{\gamma_\cD}"', from=1-1, to=2-1]
    \arrow["{\overline{g}}"', from=2-1, to=2-2]
    \arrow["g", from=1-1, to=1-2]
  \end{tikzcd}
  \]
\end{prop}
\begin{proof}
  Let's write $\Home_V^W(\cC,\cD)$ for the full subcategory of $\Home(\cC,\cD)$
  whose objects are functors $\phi$ such that $\phi(V)\subset W$. The
  equivalence
  $\gamma^*_\cC\colon\Hom(L(\cC),L(\cD))\rightarrow\Home_V(\cC,L(\cD))$ allows
  us to construct a functor
  $\Home^W_V(\cC,\cD)\rightarrow\Home_V(\cC,L(\cD))\rightarrow\Home(L(\cC),L(\cD))$
  which associates to any $\phi$ as above a functor $\overline{\phi}$ making the
  square
  \[\begin{tikzcd}
    \cD & \cC \\
    {L(\cD)} & {L(\cC)}
    \arrow["{\gamma_\cC}", from=1-2, to=2-2]
    \arrow["{\gamma_\cD}"', from=1-1, to=2-1]
    \arrow["{\overline{\phi}}"', from=2-1, to=2-2]
    \arrow["\phi", from=1-1, to=1-2]
  \end{tikzcd}\]
  commute up to $J$-homotopy.

  The proof works by observing that our map also lifts natural transformations
  functorially, which allows us to show the triangle identities for the lifted
  unit and counit.
\end{proof}

\begin{prop}
  7.1.18

  Let $u\colon\cC\rightarrow\cD$ be a functor between $\infty$-categories with a
  fully faithful right adjoint $v$ and consider $W=k(\cD)\times_\cD\cC$, the
  subcategory of maps of $\cC$ which become invertible in $\cD$. Then $u$
  exhibits $\cD$ as the localization of $\cC$ by $W$.
\end{prop}
\begin{proof}
  Given a localization $\gamma\colon\cC\rightarrow L(\cC)$ by $W$, we get a
  functor $\gamma\cdot v\colon\cD\rightarrow L(\cC)$ which, paired with the
  $\overline{u}$ obtained from the construction in the previous proof, lifts the
  adjunction $u\dashv v$ to the localizations (where $L(\cD)\cong\cD$ as we
  localize at the identities). Lifting maintains the counit invertible, which
  allows us to conclude that $\gamma\cdot v$ is fully faithful.

  Essential surjectivity
  follows from the fact that, for any object $c$ in $\cC$, the unit $\eta_c$ is
  such that $\epsilon_{u(c)}\cdot u(\eta_c)=\id_{u(c)}$ and, since $\epsilon$ is
  invertible, so is $u(\eta_c)$, thus $\eta_c$ becomes invertible in $L(\cC)$
  and shows that $(\gamma_{\cC}\cdot v)(u(c))=\gamma_{\cC}(vu(c))\cong c$.
  Notice that here we used that $L(\cC)_0=\cC_0$, which is permissible up to
  equivalence as previously noted.

  \wfd{(PLEASE CHECK PROOF)}
\end{proof}

%\begin{cor}
%  7.2.5
%\end{cor}
%\begin{proof}
%  7.1.5
%\end{proof}

%\begin{cor}
%  7.2.8
%\end{cor}
%\begin{proof}
%  7.1.5, 7.1.18, 7.2.5
%\end{proof}

%\begin{cor}
%  7.2.10
%\end{cor}

%\begin{cor}
%  7.2.15
%\end{cor}

%\begin{cor}
%  7.2.16
%\end{cor}

%\begin{cor}
%  7.2.18
%\end{cor}
%\begin{proof}
%  7.2.16
%\end{proof}

%\begin{cor}
%  7.2.25
%\end{cor}
%\begin{proof}
%  7.2.8, 7.2.10, 7.2.15
%\end{proof}

%\begin{cor}
%  7.3.2
%\end{cor}

%\begin{cor}
%  7.3.4
%\end{cor}

%\begin{cor}
%  7.3.5
%\end{cor}
%\begin{proof}
%  7.1.10, 7.3.2, 7.3.4
%\end{proof}

%\begin{cor}
%  7.3.8
%\end{cor}
%\begin{proof}
%  7.1.10, 7.1.12
%\end{proof}

%\begin{cor}
%  7.3.9
%\end{cor}
%\begin{proof}
%  7.3.8
%\end{proof}

%\begin{cor}
%  7.3.10
%\end{cor}
%\begin{proof}
%  7.3.9
%\end{proof}

%\begin{prop}
%  7.3.11
%\end{prop}

%\begin{cor}
%  7.3.15
%\end{cor}
%\begin{proof}
%  7.1.12, 7.3.9, 7.3.10
%\end{proof}

%\begin{cor}
%  7.3.16
%\end{cor}
%\begin{proof}
%  7.3.5, 7.3.15
%\end{proof}

%\begin{cor}
%  7.3.26
%\end{cor}

%\begin{cor}
%  7.3.27
%\end{cor}
%\begin{proof}
%  7.3.16, 7.3.26
%\end{proof}

%\begin{cor}
%  7.3.28
%\end{cor}

%\begin{cor}
%  7.3.29
%\end{cor}
%\begin{proof}
%  7.3.27, 7.3.28
%\end{proof}

%\begin{prop}
%  7.4.2
%\end{prop}

%\begin{prop}
%  7.4.11
%\end{prop}
%\begin{proof}
%  7.3.11, 7.4.2
%\end{proof}

\begin{defn}
  An \emph{$\infty$-category with weak equivalences and fibrations} is a triple
  $(\cC,W,Fib)$ where $\cC$ is an $\infty$-category with a final object,
  $W\subset\cC$ is a subcategory with the 2-out-of-3 property and
  $Fib\subset\cC$ a subsimplicial set such that:
  \begin{enumerate}
    \item for any morphism $p\colon x\rightarrow y$ in $Fib$ (and $W$) with $y$
      fibrant, there is in $\cC$ a pullback square
      \[\begin{tikzcd}
        {x'} & x \\
        {y'} & y
        \arrow["p", from=1-2, to=2-2]
        \arrow["{p'}"', from=1-1, to=2-1]
        \arrow["v"', from=2-1, to=2-2]
        \arrow["u", from=1-1, to=1-2]
      \end{tikzcd}\]
      where $p'$ also lies in $Fib$ (and $W$);
    \item for any map $f\colon x\rightarrow y$ with fibrant codomain can be
      factored as a map in $W$ followed by one in $Fib$.
  \end{enumerate}
  By \emph{fibrant object} we mean an object whose map to the terminal one is in
  $Fib$.

  We shall call \emph{weak equivalences} the maps in $W$ and \emph{fibrations}
  the ones in $Fib$. Maps which are both shall be referred to as \emph{trivial
  fibrations}.
\end{defn}

\begin{construction}\label{fincomplarefib}
  Any finitely complete $\infty$-category $\cC$ can be given the structure of an
  $\infty$-category with weak equivalences and fibrations by setting $W=k(\cC)$,
  $Fib=\cC$, which we will be doing henceforth.
\end{construction}

\begin{construction}
  For any $\infty$-category with weak equivalences and fibrations $\cC$ and a
  fibrant object $c$, we can give to the slice category $\cC/c$ the structure of an
  $\infty$-category with weak equivalences and fibrations by specifying as weak
  equivalences the morphisms which are mapped to weak equivalences of $\cC$ by
  the projection $\cC/c\rightarrow\cC$ and similarly for the fibrations.
\end{construction}

\begin{defn}
  An $\infty$-category of fibrant objects is an $\infty$-category with weak
  equivalences and fibrations $\cC$ in which all objects are fibrant.
\end{defn}

\begin{construction}
  For any $\infty$-category with weak equivalences and fibrations $\cC$, its
  full subcategory given by fibrant objects is canonically an $\infty$-category
  of fibrant objects. We shall denote it by $\cC_f$ and its weak equivalences
  are given by $W_f=W\cap\cC_f$, its fibrations by $Fib_f=Fib\cap\cC_f$.
\end{construction}

\begin{prop}[Brown's Lemma]\label{7413}
  7.4.13

  For any map $f\colon x\rightarrow y$ between fibrant objects in an
  $\infty$-category with weak equivalences and fibrations $\cC$, there exists a
  commutative diagram of the form
  \[\begin{tikzcd}
    & x \\
    x & z & y
    \arrow[Rightarrow, no head, from=1-2, to=2-1]
    \arrow["s", from=1-2, to=2-2]
    \arrow["p", "\sim"', two heads, from=2-2, to=2-1]
    \arrow["q"', two heads, from=2-2, to=2-3]
    \arrow["f", from=1-2, to=2-3]
  \end{tikzcd},\]
  where $s$ is a weak equivalence, $p$ a trivial fibration and $q$ a fibration.
\end{prop}
\begin{proof}
  Since $x$ and $y$ are fibrant, the pullback of $x\rightarrow e$ and
  $y\rightarrow e$ exists and it corresponds to $x\times y$. The maps $\id_x$,
  $f$ define a cone over our cospan which induces a map $g\colon x\rightarrow
  x\times y$ and we then
  factor the latter as a weak equivalence $s\colon x\rightarrow z$ followed by a
  fibration $\pi\colon z\rightarrow x\times y$. We get then the desired maps
  $p=p_x\cdot\pi$, $q=p_y\cdot\pi$, where $p_x$, $p_y$ denote the projections
  $x\times y\rightarrow x$, $x\times y\rightarrow y$ respectively.
\end{proof}

\begin{cor}\label{7414}
  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations, $\cD$
  an $\infty$-category and $V\subset \cD$ a subcategory with the 2-out-of-3
  property. If $F$ sends trivial fibrations between fibrant objects into $V$,
  then it also sends weak equivalences between fibrant objects into $V$.
\end{cor}
\begin{proof}
  Looking at the commutative diagram
  \[\begin{tikzcd}
    x \\
    {} & z & y \\
    x
    \arrow["s"', from=1-1, to=2-2]
    \arrow["p"', two heads, from=2-2, to=3-1]
    \arrow[Rightarrow, no head, from=1-1, to=3-1]
    \arrow["f"', curve={height=12pt}, from=3-1, to=2-3]
    \arrow["f", curve={height=-12pt}, from=1-1, to=2-3]
    \arrow["q", from=2-2, to=2-3]
  \end{tikzcd},\]
  given by Brown's Lemma \ref{7413} we see that $Fp$ lies in $V$ and therefore
  the same goes for $Fs$. Also, since $f$ and $s$ are weak equivalences we know
  that $q$ is too, hence it is a trivial fibration. It follows that $Fq$ is in
  $V$ and the same goes for $Ff=Fq\cdot Fs$.
\end{proof}

\begin{construction}
  Given an $\infty$-category with weak equivalences and fibrations $\cC$ and a
  fibrant object $z$ in it, we write $\cC(z)$ for $(\cC/z)_f$, that is the
  full subcategory $\cC/z$ given by the fibrations $x\rightarrow z$ of $\cC$.
  For any morphism $f\colon x\rightarrow y$ between fibrant objects, we have a
  left exact functor
  $f^*\colon\cC(y)\rightarrow\cC(x)$ induced pulling back along $f$
  \wfd{(CAREFUL WITH THIS! YOU ARE USING IT LATER ON; CHECK \cite[Prop.\
  7.4.15]{Cis19})}. The existence follows from the fact that pullbacks along
  fibrations with fibrant codomain exist, while left exactness comes from limits
  commuting and weak equivalences being preserved as a consequence of
  \ref{7414}. \wfd{(PERHAPS MORE DETAIL?)}
\end{construction}


%\begin{cor}
%  7.4.14
%\end{cor}
%\begin{proof}
%  7.4.13
%\end{proof}

%\begin{prop}
%  7.4.16
%\end{prop}
%\begin{proof}
%  7.4.13
%\end{proof}

%\begin{prop}
%  7.4.19
%\end{prop}
%\begin{proof}
%  7.4.11
%\end{proof}

\begin{defn}
  Let $\cC$, $\cD$ be $\infty$-categories with weak equivalences and fibrations.
  A functor $F\colon\cC\rightarrow\cD$ is \emph{left exact} if it has the
  following properties:
  \begin{enumerate}
    \item the functor $F$ preserves final objects;
    \item the functor $F$ sends (trivial) fibrations between fibrant objects to
      (trivial) fibrations;
    \item the functor $F$ preserves any pullback square in $\cC$
      \[\begin{tikzcd}
        {x'} & x \\
        {y'} & y
        \arrow["{p'}"', from=1-1, to=2-1]
        \arrow["p", from=1-2, to=2-2]
        \arrow["u", from=1-1, to=1-2]
        \arrow["v"', from=2-1, to=2-2]
      \end{tikzcd}\]
      where $p$ is a fibration and $y$, $y'$ are fibrant objects.
  \end{enumerate}
\end{defn}

\begin{rmk}
  By Brown's Lemma, a left exact functor preserves weak equivalences between
  fibrant objects.
\end{rmk}

\begin{rmk}
  When considering a functor $F$ between finitely complete $\infty$-categories,
  left exactness is equivalent to preserving finite limits.
\end{rmk}

\begin{prop}\label{756}
  7.5.6

  Given an $\infty$-category with weak equivalences and fibrations $\cC$, the
  localization $L(\cC_f)$ has finite limits and the localization functor
  $\cC_f\rightarrow L(\cC_f)$ is left exact. Moreover, for any $\infty$-category
  $\cD$ with finite limits and any left exact functor
  $f\colon\cC_f\rightarrow\cD$, the induced functor $\overline{F}\colon
  L(\cC_f)\rightarrow\cD$ is left exact.
\end{prop}
\begin{proof}
  Maybe do not prove it? It relies on a bunch of results from ch. 7.2, 7.3, 7.4
  which we do not really want to prove.

  7.1.10, 7.2.18, 7.2.25, 7.3.27, 7.4.13, 7.4.16

  We know by \ref{7110} that $L(\cC_f)$ has a final object, hence to show
  completeness it is enough to prove that it also has pullbacks (\cite[Thm.\
  7.3.27]{Cis19}). This can be done using the fact that any morphism in
  $L(\cC_f)$ can be seen as a composition $\gamma(p)\cdot\gamma(s)^{-1}$, where
  $s$ is a trivial fibration, for which Cisinski uses the theory of the
  \emph{right calculus of fractions}, and the fact that $\gamma_f$ preserves
  pullbacks along fibrations. The proof also shows us that all pullback squares
  in $L(\cC_f)$ are isomorphic to images of pullback squares in $\cC_f$ in which
  all maps are fibrations.
\end{proof}

\begin{prop}\label{7516}
  7.5.16

  Let $x$ be a fibrant object in an $\infty$-category with weak equivalences and
  fibrations $\cC$. The induced functor
  $\cC_f/\gamma_f(x)\rightarrow\cC/\gamma(x)$ is final.
\end{prop}
\begin{proof}
  We have that $\cC_f/\gamma_f(x)=L(\cC_f)/\gamma_f(x)\times_{L(\cC_f)}\cC_f$
  and $\cC/\gamma(x)=L(\cC)/\gamma(x)\times_{L(\cC)}\cC$ and the functor we are
  considering is induced by $\overline{\iota}\colon L(\cC_f)\rightarrow L(\cC)$.
  
  To prove that it is final, it is sufficient to show that for any object
  $(c,u)$ of $L(\cC)/\gamma(x)$ the coslice $(c,u)\backslash(\cC_f/\gamma_f(x))$ is
  weakly contractible and, to do this, by \cite[Lem.\ 4.3.15]{Cis19} we can show
  that any functor $F\colon E\rightarrow (c,u)\backslash(\cC_f/\gamma_f(x))$, where $E$
  is the nerve of a finite partially ordered set, is $\Delta^1$-homotopic to a
  constant functor. This can be done through the theory of Reedy fibrant
  diagrams developed in \cite[Ch.\ 7.4]{Cis19}.
\end{proof}

\begin{prop}\label{7517}
  7.5.17

  Let $\bfU$ be a universe and $\cC$ a $\bfU$-small $\infty$-category with weak
  equivalences and fibrations. For any $\infty$-category $\cD$ with $\bfU$-small
  colimits and any functor $F\colon\cC\rightarrow\cD$, we have an isomorphism
  \[(\gamma_f)_!\iota^*(F)\cong\overline{\iota}^*\gamma_!(F)\]
  induced by the square
  \[\begin{tikzcd}
    {\cC_f} & \cC \\
    {L(\cC_f)} & {L(\cC)}
    \arrow["\gamma", from=1-2, to=2-2]
    \arrow["{\gamma_f}"', from=1-1, to=2-1]
    \arrow["\iota", from=1-1, to=1-2]
    \arrow["{\overline{\iota}}"', from=2-1, to=2-2]
  \end{tikzcd},\]
  which commutes up to $J$-homotopy.
\end{prop}
\begin{proof}
  We only need to prove that the evaluation of the canonical map
  $(\gamma_f)_!\iota^*(F)\cong\overline{\iota}^*\gamma_!(F)$ at any object $x$
  of $\cC_f$ is invertible. This evaluation is equivalent by \cite[Prop.\
  6.4.9]{Cis19} to the map
  \[\colim_{\cC_f/\gamma_f(x)}i^*(F)/\gamma_f(x)\rightarrow\colim_{\cC/\gamma(x)}F/\gamma(x),\]
  where $F/\gamma(x)$ is define by composing $F$ with the canonical projection
  $\cC/\gamma(x)\rightarrow\cC$ and similarly for $i^*(F)/\gamma_f(x)$. Using
  \ref{7516} and the commutativity of the square above, we get that the desired
  map is indeed invertible for all $x$.
\end{proof}

\begin{prop}\label{7518}
  7.5.18

  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations. The
  canonical functor $\overline{\iota}\colon L(\cC_f)\rightarrow L(\cC)$ is an
  equivalence of $\infty$-categories, hence the $\infty$-category $L(\cC)$ is
  finitely complete and the localization functor $\gamma\colon\cC\rightarrow
  L(\cC)$ is left exact.
\end{prop}
\begin{proof}
  7.5.6, 7.5.17

  We already know that $\overline{\iota}$ is essentially surjective as every
  object in $\cC$ is weakly equivalent to one in $\cC_f$ and the localization
  functors are essentially surjective themselves, thus it is enough to prove
  that it is fully faithful. To do this, we may fix a universe $\bfU$ such that
  $\cC$ is $\bfU$-small and prove that the functor
  \[\overline{\iota}_!\colon\Home(L(\cC_f),\cS)\rightarrow\Home(L(\cC),\cS)\]
  is fully faithful and use \cite[Prop.\ 6.1.15]{Cis19}. Remember that this full
  faithfulness condition is equivalent to the unit map
  $1\rightarrow\overline{\iota}^*\overline{\iota}_!$ of the adjunction
  $\overline{\iota}_!\dashv\overline{\iota}^*$ being invertible.

  We know that $\overline{\iota}_*$ and $\overline{\iota}^*$ both have right
  adjoints, thus they preserve colimits. Also, every $\cS$-valued functor
  indexed by a $\bfU$-small $\infty$-category can be obtained as a colimit of
  representable ones, hence it is enough to check that the condition holds for
  any representable functor $F$. Also, $\gamma_f$ is essentially surjective,
  which means that it is sufficient to check that map
  $(\gamma_f)_!\rightarrow\overline{\iota}^*\overline{\iota}_!(\gamma_f)_!$
  which we get by precomposing the unit with $(\gamma_f)_!$ is invertible.

  We have then the chain of isomorphisms
  \begin{align*}
    (\gamma_f)_! &\cong(\gamma_f)_!\overline{\iota}^*\overline{\iota}_! \\
                 &\cong\overline{\iota}^*\gamma_f\iota_! \\
                 &\cong\overline{\iota}^*\overline{\iota}_!(\gamma_f)_!,
  \end{align*}
  where the first isomorphism comes from the full faithfulness of $\iota$, the
  second one from \ref{7517} and the last one the fact that
  $\overline{\iota}\cdot\gamma_f\cong\gamma\cdot\iota$, as noted in \ref{7517}.

  The second claim follows directly from the first one and \ref{756}.
\end{proof}

\begin{rmk}
  Here we see that the theory of localizations of $\infty$-categories with weak
  equivalences and fibrations provides much better results the 1-categorical
  equivalent, embodied by the homotopy theory of model categories and fibration
  categories (which we will define in the next chapter): indeed, these are
  particular cases of the $\infty$-analogue, however their homotopy categories,
  i.e.\ their 1-categorical localizations by weak equivalences, are almost never
  finitely complete.
\end{rmk}

\begin{cor}\label{7519}
  7.5.19

  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations. For a
  morphism between fibrant objects $p\colon x\rightarrow y$, the following
  conditions are equivalent:
  \begin{enumerate}
    \item the morphism $p$ has a section in $ho(L(\cC))$;
    \item there exists a morphism $p'\colon x'\rightarrow x$ s.t.\ the
      composition of $p'$ and $p$ is a weak equivalence;
    \item there exists a fibration $p'\colon x'\rightarrow x$ s.t.\ the
      composition of $p'$ and $p$ is a weak equivalence.
  \end{enumerate}
\end{cor}
\begin{proof}
  7.5.18

  We see that (iii) trivially implies (ii), therefore we shall focus on the
  other implication. Given then such a morphism $p'$, we factor it as $qi=p'$, a
  weak equivalence followed by a fibration. Since $p\cdot p'=p\cdot(q\cdot
  i)=(p\cdot q)\cdot i$, by 2-out-of-3 $p\cdot q$ is a weak equivalence, giving
  us what we wanted.

  Should we prove (i)? Uses right calculus of fractions, but it's rather simple.
\end{proof}

\begin{construction}\label{7522}
  7.5.22
  
  Given an $\infty$-category $\cC$ with weak equivalences and fibrations, we can
  get another one $\overline{\cC}$ with the same underlying $\infty$-category
  and class of fibrations, but where the weak equivalences are given by the
  saturation $\overline{W}$ as described in \ref{715}. We have that $L(\cC)\cong
  L(\overline{\cC})$, hence in general we can substitute $\cC$ by
  $\overline{\cC}$ with no issues. Also, the substitution commutes with the
  formation of slices over fibrant objects, that is, for any fibrant object $x$
  of $\cC$, a map in $\cC/x$ induces an invertible map in $L(\cC/x)$ if and only
  if its image becomes invertible in $L(\cC)$, which can be seen as a
  consequence of \ref{7519}.
\end{construction}

\begin{rmk}
  Let $\cC$ be an $\infty$-category with weak equivalences $W$ and
  $F\colon\cC\rightarrow\cD$ be a functor. The precomposition functor
  $\gamma^*\colon\Home(L(\cC),\cD)\rightarrow\Home(\cC,\cD)$ does not have a
  left adjoint in general, but we may ask whether $\Hom(F,\gamma^*(-))$ is
  representable in $\Home(L(\cC),\cD)$. If it is, a representative is denoted by
  $\bfR F\colon L(\cC)\rightarrow\cD$ and is called the \emph{right derived
  functor of $F$}. Beware that to be precise one would have to specify the
  natural transformation $F\rightarrow\bfR F\cdot\gamma$ exhibiting it as such.
  Dually, a representative of $\Hom(\gamma^*(-),F)$ is the \emph{left derived
  functor of $F$}.
\end{rmk}

\begin{prop}\label{7524}
  7.5.24

  If $F\colon\cC\rightarrow\cD$ sends weak equivalences to isomorphisms, then
  the functor $\overline{F}\colon L(\cC)\rightarrow\cD$, associated to $F$ by
  the universal property of $L(\cC)$, is the right derived functor of $F$.
\end{prop}
\begin{proof}
  Let's fix a universe $\bfU$ such that $\cC$ and $\cD$ are $\bfU$-small and let
  $G\colon L(\cC)\rightarrow\cD$ be any functor. Then the invertible map
  $\overline{F}\cdot\gamma\cong F$ and the equivalence of $\infty$-categories
  $\Home(L(\cC),\cD)\simeq\Home_W(\cC,\cD)$ induce invertible maps
  $\Hom(\overline{F},G)\simeq\Hom(\overline{F}\cdot\gamma,G\cdot\gamma)\simeq\Hom(F,G\cdot\gamma)$
  in $\cS$, functorially in $G$.
\end{proof}

\begin{construction}\label{7525}
  \wfd{(NOT COMPLETE, ONE MAY SHOW THAT OUR CONSTRUCTION DOES GIVE THE RIGHT
  DERIVED FUNCTOR)}

  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations. Any
  functor $F\colon\cC\rightarrow\cD$ sending weak equivalences between fibrant
  objects to invertible maps then has a right derived functor $\bfR F$, which
  may be constructed as follows.

  First we choose a quasi-inverse $R\colon L(\cC)\rightarrow L(\cC_f)$ of the
  equivalence of $\infty$-categories specified in \ref{7518}, then we pick a
  functor $\overline{F}\colon L(\cC_f)\rightarrow\cD$ and a natural isomorphism
  $j\colon\overline{F}\cdot\gamma_f\rightarrow F\cdot\iota$. We set then $\bfR
  F=\overline{F}\cdot R$.

  What we are doing in this construction is selecting
  for every object in $\cC$ a fibrant replacement, exactly like when we talk
  about right derived functors in the context of model categories. This is
  necessary because, a priori, we are not sending all weak equivalences to
  invertible maps in $\cD$, hence we would have to show that before applying the
  universal property of localizations. Also, for any
  other functor $G\colon\cD\rightarrow\cE$, we have that $G\cdot\bfR
  F=\bfR(G\cdot F)$.
\end{construction}

\begin{defn}
  Given an $\infty$-category with weak equivalences and fibrations $\cC$ and an
  $\infty$-category with weak equivalences $\cD$, let's consider a functor
  $F\colon\cC\rightarrow\cD$ preserving weak equivalences between fibrant
  objects of $\cC$. We call the \emph{right derived functor of} $F$ the right
  derived functor of the composition
  \[\cC\xrightarrow{F}\cD\xrightarrow{\gamma_{\cD}}L(\cD),\]
  where $\gamma_\cD$ is the localization functor of of $\cD$ at its weak
  equivalences. This right derived functor of $F$ is denoted by $\bfR F$, that
  is $\bfR F=\bfR(\gamma_{\cD}\cdot F)\colon L(\cC)\rightarrow L(\cD)$, which
  makes sense since we can apply the construction \ref{7525}.
\end{defn}

There are some interesting remarks which may be included!!!!

\begin{prop}\label{7528}
  7.5.28

  For any left exact functor $F\colon\cC\rightarrow\cD$ between
  $\infty$-categories with weak equivalences and fibrations, the right derived
  functor $\bfR F\colon L(\cC)\rightarrow L(\cD)$ is left exact.
\end{prop}
\begin{proof}
  7.5.6

  We have a square
  \[\begin{tikzcd}
    {L(\cC_f)} & {L(\cD_f)} \\
    {L(\cC)} & {L(\cD)}
    \arrow["{\overline{F}}", from=1-1, to=1-2]
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=2-1]
    \arrow["{\bfR F}"', from=2-1, to=2-2]
  \end{tikzcd}\]
  commuting up to $J$-homotopy, where the vertical maps are equivalences of
  $\infty$-categories and $\overline{F}$ is the functor obtained by restricting
  $F$ to the subcategories of fibrant objects $\cC_f$ and $\cD_f$. It therefore
  suffices to show that $\overline{F}$ is left exact, but this follows from
  \ref{756}.
\end{proof}

\begin{rmk}
  \wfd{(WHY DO WE NEED TO SPECIFY THIS?)}

  For the remainder of this chapter, given an $\infty$-category $\cC$,
  subcategories of weak equivalences $W\subset\cC$ are such that the inclusion
  $W\rightarrow\cC$ is an inner fibration. This means that a simplex
  $x\colon\Delta^n\rightarrow\cC$ lies in $W$ if and only if its edges
  $x|_{\Delta^{\{i,i+1\}}}\colon \{i,i+1\}\rightarrow\cC$ lie in $W$ for $0\leq
  i<n$.

  $W$ then contains all invertible maps of $\cC$ if and only if the
  aforementioned inclusion is an isofibration.
\end{rmk}

\begin{defn}
  Let $\cC$, $\cD$ be $\infty$-categories with subcategories of weak
  equivalences $W\subset\cC$, $W'\subset\cD$. A functor
  $f\colon\cC\rightarrow\cD$ has the \emph{right approximation property} if the
  following conditions hold:
  \begin{enumerate}
    \item a morphism in $\cC$ is in $W$ if and only if its image under $f$ is in
      $W'$;
    \item given objects $c$, $d$ in $\cC$, $\cD$ respectively and a map
      $\psi\colon d\rightarrow f(c)$ in $\cD$, there is a map $\phi\colon
      c'\rightarrow c$ in $\cC$ and a weak equivalence $u\colon d\rightarrow
      f(c')$ in $\cD$ such that  the triangle
      \[\begin{tikzcd}
        d & {f(c)} \\
        {f(c')}
        \arrow["\psi", from=1-1, to=1-2]
        \arrow["u"', from=1-1, to=2-1]
        \arrow["{f(\phi)}"', from=2-1, to=1-2]
      \end{tikzcd}\]
      commutes.
  \end{enumerate}
\end{defn}

\begin{prop}\label{762}
  7.6.2

  A functor $f\colon\cC\rightarrow\cD$ between $\infty$-categories such that the
  induced functor on the homotopy categories $ho(f)\colon ho(\cC)\rightarrow
  ho(\cD)$ is an equivalence of categories has the right approximation property.
\end{prop}
\begin{proof}
  Consider a map $\psi\colon d\rightarrow f(c)$. Since $ho(f)$ is essentially
  surjective, there exists an invertible map $d\rightarrow ho(f)(c')=f(c')$ in
  $ho(\cD)$, which comes from an invertible map $d\rightarrow f(c')$ of $\cD$.
  In $ho(\cD)$ we can then complete this to a triangle
  \[\begin{tikzcd}
    d & {f(c)} \\
    {f(c')}
    \arrow["{[\psi]}", from=1-1, to=1-2]
    \arrow["\sim"', from=1-1, to=2-1]
    \arrow["{[\phi]}"', from=2-1, to=1-2]
  \end{tikzcd}\]
  and, since $ho(f)$ is fully faithful, $\phi$ can be lifted to
  $\tilde{\phi}\colon c'\rightarrow c$ in $ho(\cC)$. This gives us a commutative
  triangle
  \[\begin{tikzcd}
    d & {f(c)} \\
    {f(c')}
    \arrow["\psi", from=1-1, to=1-2]
    \arrow["\sim"', from=1-1, to=2-1]
    \arrow["{f(\tilde{\phi})}"', from=2-1, to=1-2]
  \end{tikzcd}\]
  in $\cD$.
\end{proof}

\begin{exmp}
  Given an $\infty$-category with weak equivalences and fibrations $\cC$, the
  inclusion $\cC_f\rightarrow\cC$ has the right approximation property.
\end{exmp}

\begin{exmp}\label{764}
  Given a saturated $\infty$-category with weak equivalences and fibrations
  $\cC$, the localization functor $\cC\rightarrow L(\cC)$ has the right
  approximation property (\cite[Ex.\ 7.6.4]{Cis19}).
\end{exmp}

%\begin{lem}
%  7.6.5
%\end{lem}
%\begin{proof}
%  4.2.9
%\end{proof}

%\begin{lem}
%  7.6.7
%\end{lem}
%\begin{proof}
%  4.3.15, 7.4.19, 7.5.5
%\end{proof}

\begin{thm}\label{7610}
  7.6.10

  Let $f\colon\cC\rightarrow\cD$ be a functor between $\infty$-categories with
  finite limits. If $f$ commutes with them, then the following conditions are
  equivalent:
  \begin{enumerate}
    \item the functor $f$ is an equivalence of $\infty$-categories;
    \item the functor $ho(f)\colon\cC\rightarrow\cD$ is an equivalence of
      categories;
    \item the functor $f$ has the right approximation property.
  \end{enumerate}
\end{thm}
\begin{proof}
  7.3.29, 7.6.2, 7.6.5, 7.6.7

  We trivially have that (i) implies (ii) and, by \ref{762}, (iii) follows from
  (ii), hence we only have to show that (iii) gives (i). Let's assume then that
  $f$ has the right approximation property.

  Given a final object $e$ of $\cC$, $f(e)$ is still final in $\cD$ by
  \ref{7110}, thus for any object $d$ of $\cD$ we have a map $d\rightarrow f(e)$
  and, by the right approximation property, we get a commutative triangle with
  an isomorphism \wfd{(SPECIFY WHICH STRUCTURE YOU ARE CONSIDERING ON THE
  $\infty$-CATEGORIES)} $d\rightarrow f(c)$ for some $c$ in $\cC$, which gives
  us essential surjectivity.

  We are still missing full faithfulness. To do this, we use that the right
  approximation property implies that we have an equivalence of
  $\infty$-groupoids $k(f)\colon k(\cC)\rightarrow k(\cD)$ (\cite[Lem.\
  7.6.7]{Cis19}) and that, for any object $c$ of $\cC$, the map
  $\cC/c\rightarrow\cD/f(c)$ induced on the slices still has the right
  approximation property (\cite[Prop.\ 7.6.7]{Cis19}), therefore again we get an
  equivalence of $\infty$-groupoids $k(\cC/c)\rightarrow k(\cD/f(c))$.

  Keeping these facts in mind, let's look at the projection
  $\cC/c\rightarrow\cC$. This functor is conservative, thus the square
  \[\begin{tikzcd}
    {k(\cC/c)} & {\cC/c} \\
    {k(\cC)} & \cC
    \arrow[from=1-1, to=2-1]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=1-2]
  \end{tikzcd}\]
  is a pullback. We observe by pasting that the pullback of $k(\cC/c)\rightarrow
  k(\cC)$ along $c'\colon\Delta^0\rightarrow k(\cC)$ is $\cC(c',c)$, as it is
  clear from the diagram
  \[\begin{tikzcd}
    {\cC(x,y)} & {k(\cC/c)} & {\cC/c} \\
    {\Delta^0} & {k(\cC)} & \cC
    \arrow[from=1-2, to=2-2]
    \arrow[from=2-2, to=2-3]
    \arrow[from=1-3, to=2-3]
    \arrow[from=1-2, to=1-3]
    \arrow["{c'}"', from=2-1, to=2-2]
    \arrow[from=1-1, to=2-1]
    \arrow[from=1-1, to=1-2]
  \end{tikzcd}.\]
  In the same way, we get that the pullback of $k(\cD/f(c))\rightarrow k(\cD)$
  along $f(c')\colon\Delta^0\rightarrow k(\cD)$ is $\cD(f(c'),f(c))$. Since we
  have a commutative square
  \[\begin{tikzcd}
    {k(\cC/c)} & {k(\cD/f(c))} \\
    {k(\cC)} & {k(\cD)}
    \arrow[from=1-2, to=2-2]
    \arrow[from=1-1, to=1-2]
    \arrow[from=2-1, to=2-2]
    \arrow[from=1-1, to=2-1]
  \end{tikzcd}\]
  where the horizontal maps are equivalences of $\infty$-groupoids, the
  induced map $\cC(c',c)\rightarrow\cD(f(c'),f(c))$ is again an equivalence of
  $\infty$-groupoids, which is what we wanted.

  Since $f$ is essentially surjective and fully faithful, it is an equivalence
  of $\infty$-categories.
\end{proof}

\begin{cor}\label{7613}
  7.6.13

  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations and
  consider a localization functor $\gamma\colon\cC\rightarrow L(\cC)$. For any
  fibrant object $x$ of $\cC$, the canonical functor $\cC/x\rightarrow
  L(\cC)/\gamma(x)$, $t\mapsto\gamma(t)$, induces an equivalence of
  $\infty$-categories $L(\cC/x)\simeq L(\cC)/\gamma(x)$.
\end{cor}
\begin{proof}
  7.5.18, 7.5.22, 7.5.24, 7.5.28, 7.6.4, 7.6.10

  By \ref{7522}, we can assume that $\cC$ is saturated. Our objective is to show
  that the induced functor $\phi\colon L(\cC/x)\rightarrow L(\cC)/\gamma(x)$ has
  the right approximation property and it preserves finite limits, which will
  allow us to apply \ref{7610} and conclude.

  To show condition (1) we only need to prove that $\phi$ is conservative, which
  can be reduced to showing that a map in $\cC/x$ becomes invertible in
  $L(\cC/x)$ if and only if it becomes an insomorphism in $L(\cC)$. This however
  is true by
  saturation of $\cC$. We still need to check condition (2), which can be done
  on $\cC/x\rightarrow L(\cC)/\gamma(x)$, but this follows from the fact that
  $\gamma$ has it, as mentioned in \ref{764}.

  To apply \ref{7610} we still need to show that $\phi$ preserves limits. To do
  this, we use the fact that $\cC/x$ has the structure of an
  $\infty$-category with weak equivalences and fibrations. Given that $\gamma$
  is left exact, the functor $\cC/x\rightarrow L(\cC)/\gamma(x)$ maps weak
  equivalences to isomorphisms and we can apply \ref{7524} to prove that $\phi$
  is its right derived functor. Finally, through \ref{7528} we get that $\phi$
  is also left exact.
\end{proof}

\begin{thm}\label{7616}
  7.6.16

  Let $\cC$ be an $\infty$-category with weak equivalences and fibrations. Given
  a fibrant object $x$, let $\cC(x)$ be the full subcategory of fibrant objects
  of $\cC/x$ \wfd{(INCLUDE 7.6.12)}, which will be an $\infty$-category of
  fibrant objects. Assume that, for any fibration between fibrant objects
  $p\colon x\rightarrow y$, the pullback functor
  $p^*\colon\cC(y)\rightarrow\cC(x)$, $(y'\rightarrow y)\mapsto(y'\times_y
  x\rightarrow x)$ has a right adjoint $p_*\colon\cC(x)\rightarrow\cC(y)$
  preserving trivial fibrations. Then, for any map $p\colon x\rightarrow y$ in
  $L(\cC)$, the pullback functor $p^*\colon\cC(y)\rightarrow\cC(x)$ has a right
  adjoint.
\end{thm}
\begin{proof}
  6.1.6, 6.1.7, 6.1.8, 7.1.14, 7.4.14, 7.5.18, 7.6.13

  Given a localization functor $\gamma\colon\cC\rightarrow L(\cC)$, one reduces
  the problem to proving that, for any fibration between fibrant objects
  $p\colon x\rightarrow y$, the pullback functor
  \[\gamma(p)^*\colon L(\cC)/\gamma(y)\rightarrow L(\cC)/\gamma(x)\]
  has a right adjoint.

  A consequence of Brown's Lemma \ref{7413} is that any functor preserving
  trivial fibrations between fibrant objects also preserves weak equivalences,
  and, since $p^*\colon\cC(y)\rightarrow\cC(x)$ has both a right and a left
  adjoint named $p_*$ and $p_!$ (the latter given by post-composing with $p$)
  which do preserve them, by \ref{7114} we have a pair of adjunctions on the
  localizations, namely
  \[\adjunction{\overline{p}^*}{L(\cC(y))}{L(\cC(x))}{\overline{p}_*},\]
  \[\adjunction{\overline{p}_!}{L(\cC(x))}{L(\cC(y))}{\overline{p}^*}.\]

  Given that $(\cC/z)_f=\cC(z)$ for all fibrant objects $z$ of $\cC$, by
  \ref{7518} we have that $L(\cC(z))\simeq L(\cC/z)$ and, by $\ref{7613}$, we
  also know that $L(\cC/z)\simeq L(\cC)/\gamma(z)$, hence $L(\cC(z))\simeq
  L(\cC)/\gamma(z)$. Notice that $\overline{p}_!$ is equivalent to
  $\gamma(p)_!\colon L(\cC)/\gamma(x)\rightarrow L(\cC)/\gamma(y)$ and, by
  essential uniqueness of the adjoints, this extends to $\gamma(p)^*$ and
  $\overline{p}^*$, therefore $\gamma(p)^*$ has a right adjoint induced by
  $\overline{p}_*$.
\end{proof}

\section{Categorical Models of TT as Locally Cartesian Closed Fibration
Categories}

To apply the results from the previous section, we first need to specify a
fibrational structure on categorical models of type theory.

\begin{defn}
  A \emph{fibration category} is a triple $(\cP,W,Fib)$ where $\cP$ is a
  category and $W$, $Fib$ are wide subcategories such that:
  \begin{enumerate}
    \item $\cP$ has a terminal object;
    \item maps to the terminal object lie in $Fib$;
    \item $Fib$ and $W\cap Fib$ are closed under pullback along any map in $\cP$;
    \item every map in $\cP$ can be factored as a map in $W$ followed by one in
      $Fib$;
    \item $W$ has the 2-out-of-6 property.
  \end{enumerate}
\end{defn}

\begin{rmk}
  Seeing $\cP$, $W$ and $Fib$ in the above definition as $\infty$-categories, we
  notice that the triple has canonically the structure of an $\infty$-category
  with weak equivalences and fibrations with fibrant objects, hence we shall
  adopt the conventions we used in that context.
\end{rmk}

Now we have to specify the classes of maps which will provide the desired
structure.

\begin{defn}
  Given a categorical model of type theory $\cC$, a morphism
  $f\Gamma.A\rightarrow\Gamma.B$ over $\Gamma$ is \emph{simply bi-invertible
  over $\Gamma$} if there exist:
  \begin{enumerate}
    \item a morphism$g_1\colon\Gamma.B\rightarrow\Gamma.A$;
    \item a section $\eta\colon\Gamma.A\rightarrow\Gamma.(1_{\Gamma.A},g_1f)^*\Id_{A}$
      of the canonical projection
      $p_{(1_{\Gamma.A},g_1f)^*\Id_{A}}\colon
      \Gamma.(1_{\Gamma.A},g_1f)^*\Id_{A}\rightarrow\Gamma.A$;
    \item a morphism $g_2\colon\Gamma.B\rightarrow\Gamma.A$;
    \item a section
      $\epsilon\colon\Gamma.A\rightarrow\Gamma.(1_{\Gamma.A},fg_2)^*\Id_{A}$ of
      the canonical projection
      $p_{(1_{\Gamma.A},fg_2)^*\Id_{A}}\colon
      \Gamma.(1_{\Gamma.A},fg_2)^*\Id_{A}\rightarrow\Gamma.A$.
  \end{enumerate}
\end{defn}

We now generalize the above definition to general context extensions by working
as usual with $\cC^{cxt}$.

\begin{defn}
  Given a categorical model of type theory $\cC$, a morphism
  $f\colon\Gamma.\Delta\rightarrow\Gamma.\Theta$ over $\Gamma$ is
  \emph{bi-invertible over $\Gamma$} if it is as a morphism in $\cC^{cxt}$. It
  is simply called \emph{bi-invertible} when $\Gamma$ is the terminal
  context.
\end{defn}

\begin{defn}
  A fibration category $\cP$ is \emph{locally cartesian closed} if, for any
  fibration $p\colon a\rightarrow b$, the pullback functor
  $p^*\colon\cP\downarrow b\rightarrow\cP\downarrow a$ admits a right adjoint
  $p_*$ which is an exact functor.
\end{defn}

\begin{rmk}
  Our interest in bi-invertible morphisms stems from the fact that they model
  the right notion of invertible map in dependent type theory: indeed, from the
  required data for a simply bi-invertible map $f$ over $\Gamma$ we can provide
  a section $\Gamma\rightarrow\Gamma. isHIso(f)$ of the dependent projection
  $p_{\Gamma.isHIso(f)}\colon\Gamma.isHIso(f)\rightarrow\Gamma$ REFS, which is
  the translation into the language of contextual category of the notion of
  bi-invertible map in type theory MORE REFS.

  It is important to note that, while type theory has no way to encode
  internally the concept of isomorphism of the contextual model, it does have
  its own internal notion of isomorphism. However, given a map $f$, the type
  $isIso(f)$ is not, in general, a \emph{mere proposition}. On the other hand,
  the more lax notion of bi-invertibility is such that $isHIso(f)$ is a mere
  proposition \wfd{(UNDER WHICH HP? LEMMA 5.12 from 1203.3253)}, which makes it
  preferable. Also, every bi-equivalent map can be given the structure of an
  isomorphism and viceversa, hence they are closely related.
\end{rmk}

\begin{prop}\wfd{(REFS, 1507, AKL15, 1610.00037)}
  A categorical model of type theory $\cC$ carries the structure of a fibration
  category where maps isomorphic to dependent projections are the fibrations and
  bi-invertible ones are the weak equivalences.
\end{prop}

\wfd{(CAREFUL: AS STATED IN AKL15, WE ALSO NEED THE UNIT TYPE AND OTHER STUFF!
BUT KAPULKIN DOESN'T TAKE IT IN 1507)}

The above result can be however generalized.

\begin{prop}
  A contextual category with an $\Id$-structure $\cC$ carries the
  structure of a fibration category similar to the one above.
\end{prop}
\begin{proof}
  As noted in AKL15, 1507 and 1610.00037, the previous result does not depend on a
  $\Sigma$-structure because all we need is that every dependent projection is
  isomorphic to a basic one, which we have by working with context extensions in
  $\cC^{cxt}$. Indeed, after constructing the fibrational structure there, we may
  lift it back through the equivalence of categories $\cC\rightarrow\cC^{cxt}$.
\end{proof}

How does Kapulkin prove that a categorical model of Type Theory is a locally
cartesian closed fibration category?

First of all, he refers to AKL15 to show that $\cP$ has a fibrational structure,
then he goes on to show the following results, whose proofs are extremely terse
and therefore should be expanded.


\begin{defn}
  Given $p_A\colon\Gamma.A\rightarrow\Gamma$, a section
  $a\colon\Gamma\rightarrow\Gamma.A$ and $f\colon\Delta\rightarrow\Gamma$, we
  look at the commutative diagram
  \[\begin{tikzcd}
    \Delta \\
    & {\Delta.f^*A} & {\Gamma.A} \\
    & \Delta & \Gamma \\
    \arrow["{p_A}", from=2-3, to=3-3]
    \arrow["f"', from=3-2, to=3-3]
    \arrow["{p_{f^*A}}", from=2-2, to=3-2]
    \arrow["{q(f,A)}"', from=2-2, to=2-3]
    \arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=2-2, to=3-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow["{a\cdot f}", curve={height=-12pt}, from=1-1, to=2-3]
    \arrow["{f^*a}"{description}, dotted, from=1-1, to=2-2]
  \end{tikzcd},\]
  which gives us $f^*a$ as the factorization through the pullback square of the
  pair $(\id_\Delta,a\cdot f)$.

  \wfd{(THIS CAN BE JUSTIFIED BY LOOKING AT LEMMA 2.15 IN 1706.03605. THE
  FOLLOWING RESULT SHOWS THAT THIS ASSIGNMENT IS ALSO FUNCTORIAL.)}
\end{defn}

\begin{lem}
  For any dependent projection $p_\Delta\colon\Gamma.\Delta\rightarrow\Gamma$ in
  a categorical model of type theory $\cC$, the pullback functor
  $p_\Delta^*\colon\cC\downarrow\Gamma\rightarrow\cC\downarrow\Gamma.\Delta$
  admits a right adjoint.
\end{lem}
\begin{proof}
  Let's set $(p_\Delta)_*(\Gamma.\Delta.\Theta)=\Gamma.\Pi(\Delta.\Theta)$. Our
  counit shall be given by
  \[\epsilon_{\Gamma.\Delta.\Theta}\colon\Gamma.\Delta.p^*_\Delta\Pi(\Delta,\Theta)
  \xrightarrow{exch_{\Delta,\Pi(\Delta,\Theta)}}\Gamma.\Pi(\Delta,\Theta).p^*_{\Pi(\Delta,\Theta)}\Delta
  \xrightarrow{\app_{\Delta,\Theta}}\Gamma.\Delta.\Theta\]
  and it is then sufficient to prove that, for any context morphism
  $f\colon\Gamma.\Delta.p^*_\Delta\Psi\rightarrow\Gamma.\Delta.\Theta$ over
  $\Gamma.\Delta$, there is
  a unique $\tilde{f}\colon\Gamma.\Psi\rightarrow\Gamma.\Pi(\Delta,\Theta)$
  making the diagram
  \[\begin{tikzcd}
    {\Gamma.\Delta.p^*_\Delta\Psi} \\
    {\Gamma.\Delta.p^*_\Delta\Pi(\Delta,\Theta)} & {\Gamma.\Delta.\Theta}
    \arrow["f", from=1-1, to=2-2]
    \arrow["{\epsilon_{\Gamma.\Delta.\Theta}}"', from=2-1, to=2-2]
    \arrow["{p^*_\Delta\tilde{f}}"', dotted, from=1-1, to=2-1]
  \end{tikzcd}\]
  commute. This will then uniquely specify how the right adjoint acts on the
  morphisms.

  We start by specifying the unit
  $\eta_{\Gamma.\Psi}\colon\Gamma.\Psi\rightarrow\Gamma.\Pi(\Delta,p^*_{\Delta}\Psi)$.

  Let's consider the commutative square
  \[\begin{tikzcd}
    {\Gamma.\Psi.p^*_\Psi\Pi(\Delta,p^*_\Delta\Psi)} & {\Gamma.\Pi(\Delta,p^*_\Delta\Psi)} \\
    {\Gamma.\Psi} & \Gamma
    \arrow["{p_{\Pi(\Delta,p^*_\Delta\Psi)}}"', from=1-1, to=2-1]
    \arrow["{p_{\Psi}}"', from=2-1, to=2-2]
    \arrow["{p_{\Pi(\Delta,p^*_\Delta\Psi)}}", from=1-2, to=2-2]
    \arrow["{q(p_\Psi,\Pi(\Delta,p^*_\Delta\Psi))}", from=1-1, to=1-2]
  \end{tikzcd}\]
  where the map $q(p_\Psi,\Pi(\Delta,p^*_\Delta\Psi))$ acts by forgetting the
  term of $\Psi$. If we can provide a section of the vertical map on the left
  pointing to the term $\lambda a.const_a$, we are done as we can then compose
  it with $q(p_\Psi,\Pi(\Delta,p^*_\Delta\Psi))$ to get our unit.
  
  We construct it by looking at the commutative square
  \[\begin{tikzcd}
    {\Gamma.\Psi} \\
    & {\Gamma.\Psi.p^*_\Psi\Psi} & {\Gamma.\Psi} \\
    & {\Gamma.\Psi} & \Gamma
    \arrow["{p_\Psi}", from=2-3, to=3-3]
    \arrow["{p_\Psi}"', from=3-2, to=3-3]
    \arrow["{p_{p^*_\Psi\Psi}}", from=2-2, to=3-2]
    \arrow["{q(p_\Psi,\Psi)}"', from=2-2, to=2-3]
    \arrow[curve={height=12pt}, Rightarrow, no head, from=1-1, to=3-2]
    \arrow[curve={height=-12pt}, Rightarrow, no head, from=1-1, to=2-3]
    \arrow["{(1_\Psi,1_\Psi)}"{description}, dotted, from=1-1, to=2-2]
  \end{tikzcd},\]
  which gives us the term $[\Gamma,x:\Psi,x:\Psi]$. Then, we pull back along
  $p_{p^*_\Psi\Delta}$, getting a section
  $p^*_{p^*_\Psi\Delta}(1_\Psi,1_\Psi)\colon\Gamma.\Psi.p^*_\Psi\Delta\rightarrow\Gamma.\Psi.p^*_\Psi\Delta.p^*_{p^*_\Psi\Delta}\Psi$.
  We then apply $\lambda$, which gives us a section
  \[\lambda(p^*_{p^*_\Psi\Delta}(1_\Psi,1_\Psi))=\lambda(1_{p^*_\Psi\Delta},p_{p^*_\Psi\Delta})
\colon\Gamma.\Psi\rightarrow\Gamma.\Psi.p^*_\Psi\Pi(\Delta,p^*_\Delta\Psi)\]
  and we can then conclude by post-composing with
  $q(p_\Psi,\Pi(\Delta,p^*_\Delta\Psi))\colon\Gamma.\Psi.p^*_\Psi\Pi(\Delta,p^*_\Delta\Psi)\rightarrow\Gamma.\Pi(\Delta,p^*_\Delta\Psi)$,
  which provides our unit.

  We then define our lift $\tilde{f}$ as the composite
  $\Gamma.\Pi(\Delta,f)\cdot\eta_{\Gamma.\Psi}$. The commutativity of the above
  triangle follows by $\beta$-reduction, while the uniqueness of the $\tilde{f}$
  giving the desired factorization by the $\Pi_\eta$-property. \wfd{(PLEASE
  PROVE IT)}

  This also shows that $(p_{\Delta})_*(f)=\Gamma.\Pi(\Delta,f)$, meaning that
  the construction of $\Gamma.\Pi(\Delta,f)$ is functorial.
\end{proof}

We know that every fibration in $\cC$ is isomorphic to a composite of dependent
projections , so this tells us that every fibration induces an adjunction
between fibrational slices \wfd{(YOU SHOULD DEFINE THEM, MAYBE AS INFTY-CATS OF
FIBRANT OBJECTS INDUCED FROM THE SLICES)}.

We are finally ready to prove the result leading to the final one we want.

\begin{prop}\label{lccfc}
  A categorical model of type theory $\cC$ is a locally cartesian closed
  fibration category.
\end{prop}
\begin{proof}
  Kapulkin 1507.02648, Proposition 5.4.

  We already know that it is a
  fibration category by PREVIOUS RESULT. Also, for any basic dependent projection
  $\Gamma.\Delta\rightarrow\Gamma$, the pullback functor between fibrant slices
  $p^*_\Delta$ has a right adjoint $(p_\Delta)_*$ by the previous lemma.
  We only need to check that this right adjoint is
  compatible with the fibrational structure.

  As a right adjoint, $(p_\Delta)_*$ preserves limits and in particular pullbacks and
  the terminal object. Also, by LEMMA ABOUT PI OBJECTS BEING EQUAL, it preserves
  dependent projections and, by LEMMA ABOUT PRESERVING BI-INVERTIBLE MAPS, weak
  equivalences.
\end{proof}

\begin{thm}
  Given a categorical model of type theory $\cC$, the $\infty$-category $L(\cC)$
  is locally cartesian closed.
\end{thm}
\begin{proof}
  Since a fibration category is more generally a $\infty$-category with
  fibrations and weak equivalences, we can apply \ref{7616} as the hypothesis
  are satisfied by \ref{lccfc}.
\end{proof}

\section{What the hell are these things?}

In the proofs various objects are mentioned. Here we explain the constructions.

First of all, in 1211, Section B.1.1, to specify what it means to have a $\Pi$
structure they define the $app$ map taking sections
$a\colon\Gamma\rightarrow\Gamma.A$ and $f\colon\Gamma\rightarrow\Gamma.\Pi(A,B)$
of the obvious dependent projections and returning a section
$app(f,a)\colon\Gamma\rightarrow\Gamma.A.B$ such that $p_b\cdot app(f,a)=a$.
This tells us that $app(f,a):B(a)$ is essentially what we get when we apply the
map $f:\Pi(A,B)$ to $a:A$.

Also, given a section $b\colon\Gamma.A\rightarrow\Gamma.A.B$ we have a map
$\lambda(b)\colon\Gamma\rightarrow\Gamma.\Pi(A,B)$. This turns a term $b:B(x)$
dependent on $x:A$ into a map $\lambda(b)\Pi(A,B)$ associating $x:A$ to $b$ and
indeed we have that $app(\lambda(b),a)=b\cdot a$.

The context substitution properties are as expected.

We want to describe explicitly what the map
$app_{A,B}\colon\Gamma.\Pi(A,B).p^*_{\Pi(A,B)}A\rightarrow\Gamma.A.B$ is.
Intuitively, it should model the map sending a term $f:\Pi(A,B)$ and a term
$a:A$ to $f(a):B$. To construct it we first need to specify a few things.

MOVE IT




\section{Pushforward}

One may ask whether cocartesian fibrations in $\sSet$ model Pi types, which is a
piece needed to understand a novel model of dependent type theory provided by
$\sSet$. To answer this question, an explicit description of the right adjoint
$p_*$ of the pullback functor $p^*\colon\sSet/Y\rightarrow\sSet/X$ induced by a
morphism $p\colon X\rightarrow Y$ is needed.

Consider an object $f\colon T\rightarrow X$ in $\sSet/X$. What is $p_*(f)\colon
T'\rightarrow Y$? We know that a $n$-simplex $t'$ of $T'$ corresponds
bijectively to a map $t'\colon\Delta^n\rightarrow T'$, which in turn corresponds
bijectively to a commutative diagram
\[\begin{tikzcd}
	{\Delta^n} & {} & {T'} \\
	& Y
	\arrow["{t'}", from=1-1, to=1-3]
	\arrow["y"', from=1-1, to=2-2]
	\arrow["{p_*(f)}", from=1-3, to=2-2]
\end{tikzcd}\]
and, under the adjunction $p^*\dashv p_*$, we get bijectively another
commutative diagram
\[\begin{tikzcd}
	U & {} & T \\
	& X
	\arrow["t", from=1-1, to=1-3]
	\arrow["{p^*(y)}"', from=1-1, to=2-2]
	\arrow["f", from=1-3, to=2-2]
\end{tikzcd},\]
from which follows that
\[T'_n\cong\{(y,t)\ |\ y\in Y_n,\ t\in\sSet/X(p^*(y),f)\}\]
and the map $p_*(f)$ then sends $(y,t)\in T'_n$ to $y\in Y_n$.

The same method can be extended to give us the pushforward along a map of marked
simplicial sets $p\colon (X,E_X)\rightarrow (Y,E_Y)$ in $\mSet$. Specifically,
our previous construction can be adapted to give us the $n$-simplices by
starting from maps $(\Delta^n)_\flat\rightarrow p_*(T,E_T)=(T',E_{T'})$, telling
us again that
\[T'_n\cong\{(y,t)\ |\ y\in Y_n,\ t\in\mSet/X(p^*(y),f)\},\]
while to get the markings we notice that every marked edge in $p_*(T,E_T)$
corresponds to a unique map $(\Delta^1)_\natural\rightarrow p_*(T,E_T)$ and the
same procedure allows us to write
\[E_{T'}=\{(y,t)\ |\ y\in E_Y,\ t\in\mSet/X(p^*(y),f)\},\]
which fully specifies the needed data.

Now, under which conditions on $p$ does this specify a Quillen adjunction when
the slices of $\mSet$ are equipped with the contravariant model structure? If
it is a coCartesian fibration, it generally doesn't, but it does when it is a
Cartesian fibration. How can we specify an approximation $q$ of $p_*$ such that,
after localizing in the infinity-sense, we get an adjunction $p^*\dashv q$?

Idea: use the theory of bifibrations. From a coCartesian fibration $\phi\colon
X\rightarrow Y$ we can construct a bifibration $E\rightarrow X\times Y$ by
constructing the maps $p\colon E\rightarrow X$, $q\colon E\rightarrow Y$ by
first taking the pullback of $\phi$ along $ev_0\colon Y^{\Delta^1}\rightarrow Y$
and then composing the map $E\rightarrow Y^{\Delta^1}$ with $ev_1$.
\[\begin{tikzcd}
	E & X \\
	{Y^{\Delta^1}} & Y \\
	Y
	\arrow["\phi", from=1-2, to=2-2]
	\arrow["{ev_0}", from=2-1, to=2-2]
	\arrow["p", from=1-1, to=1-2]
	\arrow[from=1-1, to=2-1]
	\arrow["{ev_1}", from=2-1, to=3-1]
	\arrow["\lrcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
	\arrow["q"', curve={height=20pt}, from=1-1, to=3-1]
\end{tikzcd}\]

We want to show that, for any coCartesian morphisms $f\colon A\rightarrow Y$,
$g\colon A\rightarrow X$, we have an equivalence between $\Map_(\phi^*f,g)$ and
$\Map(f,q_*p^*(g))$.

Canonically, we have
\[E_n=\{(x,\Delta^n\times\Delta^1\xrightarrow{g}Y)\ |\ x\in X_n,\
\phi(x)=g|_{\Delta^n\times\{0\}}\}\]
and, by pasting the pullback squares, we also get
\[(\dom(p^*f))_n=\{(a,\Delta^n\times\Delta^1\xrightarrow{g} Y)\ |\ a\in A_n,\
f(a)=g|_{\Delta^n\times\{0\}}\}\]
and therefore
\begin{align*}
  (\dom(q_*p^*(f)))_n &=\{(y,q^*(y)\xrightarrow{g} p^*(f))\ |\ y\in Y_n\} \\
                      &=\{(y,p_!q^*(y)\xrightarrow{g} f)\ |\ y\in Y_n\},
\end{align*}
which we want to relate to $\phi_*(f)$.

To do this, we want to understand the maps $p_!q^*(y)\xrightarrow{g} f$ and
somehow relate them to $\phi^*(y)\rightarrow f$. By definition,
\begin{align*}
  \dom(p_!q^*(y))_k&=\dom(q^*(y))_k \\
                   &=\{(x,\Delta^k\times\Delta^1\xrightarrow{h}Y,t)\ |\ x\in
                     X_k,\ \phi(x)=h|_{\Delta^k\times\{0\}},\ t\in(\Delta^n)_k,\
                   y(t)=h|_{\Delta^k\times\{1\}}\},
\end{align*}
with $q^*(y)(x,h,t)=(x,h)$, thus $p_!q^*(y)(x,h,t)=x$.

On the other hand, we have
\[\dom(\phi^*(y))_k=\{(x,t)\ |\ x\in X_k,\ t\in(\Delta^n)_k,\ \phi(x)=y(t)\}\]
and $\phi^*(y)(t,x)=x$.

If we can create a bijection between morphisms of the form $p_!q^*(y)\rightarrow
f$ and $\phi^*(y)\rightarrow f$ we are done. Unfortunately, I do not see how we
can do this: any morphism $p_!q^*(y)\rightarrow f$ induces a
morphism $\phi^*(y)\rightarrow f$ by precomposing with the inclusion
$\phi^*(y)\rightarrow p_!q^*(y)$, $(x,t)\mapsto(x,h_{\phi(x)},t)$, where
$h_{\phi(x)}$ is obtained by precomposing $\phi(x)\colon\Delta^k\rightarrow Y$
with $p_{\Delta^k}\colon\Delta^k\times\Delta^1\rightarrow\Delta^k$, but this
association is only injective, not surjective, and I have no good idea about how
to construct others.

To construct the bijection I may start from a morphism $p_!q^*(y)->f$ and
construct another one with $\phi^*(y)$ as domain by lifting morphisms
$\Delta^k\times\Delta^1\rightarrow Y$ to decide where to map
$(x,h,t)\in\dom(p_!q^*(y))_k$, however this involves solving a coherence problem
and I would have to do so coherently to define a morphism of simplicial sets as
desired. Perhaps these restrictions actually allow a solution, but I do not
believe so.

It may also be possible that the injective morphism we mentioned earlier is a
weak equivalence with respect to our model structure, which may be enough.

We provide a counterexample to the previous claim in the context of right
fibrations. Consider
$\phi\colon\partial\Delta^1\rightarrow\Delta^1$, $i\mapsto 0$, which is a right
fibration. We have that $\phi^*(1)=0$, the empty simplicial set, thus
$\phi_*(f)^{-1}(1)\cong\Delta^0$. On the other hand, $(p_!q^*)(1)=U\amalg V$,
thus $q_*p^*(f)^{-1}(1)$ can be a disjoint union of non-zero simplicial sets,
which would then not be an equivalent $\infty$-groupoid. It follows that our map
is not, in general, a weak equivalence in the model structure of right
fibrations on slices of $\sSet$. \wfd{(MAYBE WRONG: YOU CAN'T CHECK THIS ON
FIBERS BECAUSE THESE ARE NOT FIBRANT OBJECTS IN $\sSet/Y$! NEED TO USE THE
DEFINITION CONCERNING HOMOTOPY CLASSES OF MAPS INTO FIBRANT OBJECTS IN THE
SLICE)}

If instead from a right fibration $\phi$ we first take the opposites of $\phi$
and $f$, then do the pushforward and finally we take again the opposites we get
$\phi_*(f)$, which is encoded in the following commutative diagram where the
vertical maps are isomorphisms.
\[\begin{tikzcd}
	{f\colon Z\rightarrow X} & {\sSet/X} & {\sSet/Y} & {f\colon Z\rightarrow Y} \\
	{f^{\op}\colon Z^{\op}\rightarrow X^{\op}} & {\sSet/X^{\op}} & {\sSet/Y^{\op}} & {f^{\op}\colon Z^{\op}\rightarrow Y^{\op}}
	\arrow["\op", from=1-3, to=2-3]
	\arrow["\op"', from=1-2, to=2-2]
	\arrow["{\phi^{\op}_*}"', from=2-2, to=2-3]
	\arrow["{\phi_*}", from=1-2, to=1-3]
	\arrow[maps to, from=1-1, to=2-1]
	\arrow[maps to, from=1-4, to=2-4]
\end{tikzcd}\]

The same argument extends to show that any map $\phi_*(f)\rightarrow q_*p^*(f)$
or in the other direction is not a weak equivalence in general. A concrete
example can be given by taking $f=\phi$.


\printbibliography

\end{document}

